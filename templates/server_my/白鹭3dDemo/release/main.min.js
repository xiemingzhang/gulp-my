var __reflect=this&&this.__reflect||function(t,e,i){t.__class__=e,i?i.push(e):i=[e],t.__types__=t.__types__?i.concat(t.__types__):i},__extends=this&&this.__extends||function(t,e){function i(){this.constructor=t}for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)},__decorate=this&&this.__decorate||function(t,e,i,r){var o,n=arguments.length,a=3>n?e:null===r?r=Object.getOwnPropertyDescriptor(e,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,r);else for(var s=t.length-1;s>=0;s--)(o=t[s])&&(a=(3>n?o(a):n>3?o(e,i,a):o(e,i))||a);return n>3&&a&&Object.defineProperty(e,i,a),a},__awaiter=this&&this.__awaiter||function(t,e,i,r){return new(i||(i=Promise))(function(o,n){function a(t){try{h(r.next(t))}catch(e){n(e)}}function s(t){try{h(r["throw"](t))}catch(e){n(e)}}function h(t){t.done?o(t.value):new i(function(e){e(t.value)}).then(a,s)}h((r=r.apply(t,e)).next())})},__generator=this&&this.__generator||function(t,e){function i(t){return function(e){return r([t,e])}}function r(i){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,n&&(a=n[2&i[0]?"return":i[0]?"throw":"next"])&&!(a=a.call(n,i[1])).done)return a;switch(n=0,a&&(i=[0,a.value]),i[0]){case 0:case 1:a=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(a=s.trys,!(a=a.length>0&&a[a.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!a||i[1]>a[0]&&i[1]<a[3])){s.label=i[1];break}if(6===i[0]&&s.label<a[1]){s.label=a[1],a=i;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(i);break}a[2]&&s.ops.pop(),s.trys.pop();continue}i=e.call(t,s)}catch(r){i=[6,r],n=0}finally{o=a=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}var o,n,a,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return{next:i(0),"throw":i(1),"return":i(2)}},egret3d;!function(t){var e=function(){function t(){}return t.prototype.onResetAction=function(t){},t.prototype.onIsActivate=function(t){return!1},t.prototype.onTick=function(t,e,i){},t.prototype.onIsComplete=function(t){return!0},t}();t.ActionNode=e,__reflect(e.prototype,"egret3d.ActionNode")}(egret3d||(egret3d={}));var ActorState;!function(t){t[t.Idle=0]="Idle",t[t.Move=1]="Move",t[t.Attack=2]="Attack",t[t.Death=3]="Death"}(ActorState||(ActorState={}));var Actor=function(t){function e(){var e=t.call(this)||this;return e.isMove=!1,e.onHeight=0,e.moveSpeed=400,e.hasHeight=!1,e.rotSpeed=.82,e.rotTime=800,e._clinetCurrentPose=new egret3d.Vector3D,e._movTargetPose=new egret3d.Vector3D,e._wayFixedSpeed=1,e._runToTargetAngle=0,e._curAngle=0,e._posAngle=0,e._roting=!0,e._wayDirection=new egret3d.Vector3D(1,1,1),e._wayFixSpeed=0,e._time=0,e._delay=0,e._lessDdistance=0,e._moveNeedTime=0,e._rotNeedTime=0,e._numTime=800,e._currentTime=0,e._lessAngle=0,e._delayValue=.82,e._maxRot=0,e._start=!1,e._pathLength=0,e._pathPoint=[],e._temp_vecA=new egret3d.Vector3D,e._movePathX=[],e._movePathZ=[],e._movePathIndex=0,e}return __extends(e,t),Object.defineProperty(e.prototype,"roting",{get:function(){return this._roting},set:function(t){this._roting=t},enumerable:!0,configurable:!0}),e.prototype.setState=function(t){this._state!=t&&(this._state=t)},e.prototype.actorMoveTo=function(t,e,i,r){void 0===r&&(r=!0),this._movTargetPose.x=t,this._movTargetPose.y=e,this._movTargetPose.z=i,this._wayDirection.x=-(this._clinetCurrentPose.x-this._movTargetPose.x),this._wayDirection.z=-(this._clinetCurrentPose.z-this._movTargetPose.z),this._lessDdistance=egret3d.Vector3D.distance(this.position,this._movTargetPose),(void 0==this._lessDdistance||isNaN(this._lessDdistance))&&(this._lessDdistance=0),this._moveNeedTime=this._lessDdistance/(.001*this.moveSpeed),(0!=this._wayDirection.x||0!=this._wayDirection.z)&&this._wayDirection.normalize(),isNaN(this._wayDirection.x)&&isNaN(this._wayDirection.z)&&(this._wayDirection.x=0,this._wayDirection.z=0),this.actorTrunToDirection(this._wayDirection.x,this._wayDirection.z),this.isMove=!0,this.setState(ActorState.Move)},e.prototype.actorMoveToEx=function(t,e){this._movePathX=t,this._movePathZ=e,this._movePathIndex=0,this.actorMoveTo(this._movePathX[this._movePathIndex],0,this._movePathZ[this._movePathIndex])},e.prototype.actorMoveStop=function(){this.isMove&&(this.isMove=!1)},e.prototype.jumpTo=function(t,e){this.x=this._clinetCurrentPose.x=t,this.z=this._clinetCurrentPose.z=e},e.prototype.actorTrunToDirection=function(t,e){this._runToTargetAngle=EMathEx.normalizeAngle(Math.atan2(e,t)*egret3d.MathUtil.RADIANS_TO_DEGREES),this._posAngle=this._runToTargetAngle,this._rotNeedTime=this.rotTime},e.prototype.update=function(t,e,i){this._delay=e,this._time=t,this._roting?this._posAngle=this.updateRotion(this._delay,this._runToTargetAngle):this._posAngle=this._runToTargetAngle,this.rotationY=this.currentAngle},e.prototype.updateRotion=function(t,e){if(this._rotNeedTime>=0){var i=e-this._curAngle%360;if(0==i)return this._curAngle;i=EMathEx.normalizeAngle(i),this._currentTime=0,this._numTime!=this._rotNeedTime&&(this._currentTime=(this._numTime-this._rotNeedTime)/this._numTime),this._lessAngle=1-(1-this._currentTime)*(1-this._currentTime)*this.rotSpeed,i>0?this._maxRot=-Math.abs(i*this._lessAngle):this._maxRot=Math.abs(i*this._lessAngle),this._curAngle-=this._maxRot}var r=EMathEx.normalizeAngle(this._curAngle);return this._rotNeedTime=this._rotNeedTime-t,r},Object.defineProperty(e.prototype,"currentAngle",{get:function(){return-this._posAngle+90},enumerable:!0,configurable:!0}),e}(egret3d.Object3D);__reflect(Actor.prototype,"Actor");var egret3d;!function(t){var e=function(){function t(){this.gameDefenseFactor=.06}return t.prototype.preCrit=function(t,e){return e.detailActorData.crit=e.actorData.crit+t.crit,e.detailActorData.isCrit=Math.random()>1-e.detailActorData.crit,e.detailActorData.isCrit},t.prototype.calculateDamage=function(t,e,i){for(var r,o,n=0,a=i;n<a.length;n++){var s=a[n];r=s.actorData.defense>0?1-s.actorData.defense*this.gameDefenseFactor/(s.actorData.defense*this.gameDefenseFactor+1):-1-Math.pow(1-this.gameDefenseFactor,s.actorData.defense),o=(1+e.detailActorData.critDamage)*((t.attack_ad+t.attack_ap+e.actorData.attack)*r),o=Math.ceil(o),e.detailActorData.mp=t.mp,s.detailActorData.hp=o,s.actorData.hp=s.actorData.hp-o}},t}();t.DamageTools=e,__reflect(e.prototype,"egret3d.DamageTools"),t.damageTools=new e;var i=function(){function t(){this.eventTime=0,this.isParallel=!1,this.nextNode=[],this.immediatelyNodes=[],this.complete=!1}return t.prototype.tick=function(t,e){},t.prototype.decision=function(){},t}();t.LogicNode=i,__reflect(i.prototype,"egret3d.LogicNode");var r=function(t){function e(){var e=t.call(this)||this;return e.delayTime=0,e.eventTime=0,e.isParallel=!1,e}return __extends(e,t),e.prototype.tick=function(t,e){this.delayTime-=e,this.delayTime<0&&(this.complete=!0,this.nextNode=[this.performer.logicList.StartGameLogic])},e.prototype.decision=function(){},e}(i);t.DelayLogic=r,__reflect(r.prototype,"egret3d.DelayLogic");var o=function(t){function e(){var e=t.call(this)||this;return e.eventTime=0,e.isParallel=!1,e}return __extends(e,t),e.prototype.tick=function(t,e){this.complete=!0,this.nextNode=[this.performer.logicList.MobLogic]},e.prototype.decision=function(){},e}(i);t.StartGameLogic=o,__reflect(o.prototype,"egret3d.StartGameLogic");var n=function(t){function e(){var e=t.apply(this,arguments)||this;return e.nextWave=1e5,e.time=0,e.mobDelayTime=1e3,e.monstCount=0,e.gameTime=0,e}return __extends(e,t),e}(i);t.MobLogic=n,__reflect(n.prototype,"egret3d.MobLogic");var a=function(e){function i(){var t=e.call(this)||this;return t.aiRadius=1500,t.isLongRange=!1,t.attackRange=280,t.keepMinRange=180,t.tickTime=1001,t.tickCycle=1e3,t.eventTime=-1,t.isParallel=!1,t}return __extends(i,e),i.prototype.getNear=function(){for(var e,i=this.aiRadius,r=0,o=this.performer.gameRoom.actorlist;r<o.length;r++){var n=o[r];if(this.performer.self!=n&&n.groupID!=this.performer.self.groupID){var a=t.Vector3D.distance(this.performer.self.position,n.position);i>a&&(i=a,n.distance=a,e=n)}}return e},i.prototype.getNearPoint=function(e){var i=360*Math.random(),r=Math.sin(i)*this.keepMinRange+e.position.x,o=Math.cos(i)*this.keepMinRange+e.position.z;return t.Vector3D.HELP_0.x=r,t.Vector3D.HELP_0.z=o,t.Vector3D.HELP_0},i.prototype.tick=function(t,e){if(this.tickTime>this.tickCycle){this.tickTime=0;var i=this.getNear();if(i&&1!=i.groupID&&i.groupID!=this.performer.self.groupID){var r=i.distance;if(r<this.aiRadius)if(r<=this.attackRange&&r>this.keepMinRange-32&&r<this.keepMinRange+32)this.nextNode=[this.performer.logicList.AttackLogic],this.performer.targetList.push(i),this.performer.targetList=[i],this.complete=!0;else{var o=this.getNearPoint(i),n=this.performer.logicList.MoveLogic;n.move(o),this.performer.targetList=[i],this.nextNode=[n],this.complete=!0}else this.performer.targetList.length=0}}this.tickTime+=e},i}(i);t.PatrolLogic=a,__reflect(a.prototype,"egret3d.PatrolLogic");var s=function(e){function i(){var i=e.call(this)||this;return i.targetPos=new t.Vector3D,i.tickDelay=160,i.time=0,i.eventTime=-1,i.isParallel=!1,i}return __extends(i,e),i.prototype.move=function(t){this.targetPos.copyFrom(t),this.performer.self.actorMoveTo(this.targetPos.x,0,this.targetPos.z)},i.prototype.tick=function(t,e){this.time>this.tickDelay&&(this.performer.self.isMove?this.move(this.targetPos):(this.complete=!0,this.nextNode=[this.performer.logicList.PatrolLogic],this.performer.self.actorTrunToDirection(this.targetPos.x,this.targetPos.z)),this.time=0),this.time+=e},i}(i);t.MoveLogic=s,__reflect(s.prototype,"egret3d.MoveLogic");var h=function(e){function i(){var t=e.call(this)||this;return t.time=0,t.eventTime=-1,t.isParallel=!1,t}return __extends(i,e),i.prototype.tick=function(e,i){if(this.performer.targetList.length>0){this.player=this.performer.self.itemConfig;var r=this.performer.targetList[0];if(this.time>5*this.player.attack_speed){var o=t.Vector3D.distance(this.performer.self.position,r.position);280>o?(t.Vector3D.HELP_0.x=-(this.performer.self.x-r.position.x),t.Vector3D.HELP_0.z=-(this.performer.self.z-r.position.z),t.Vector3D.HELP_0.normalize(),this.performer.self.actorTrunToDirection(t.Vector3D.HELP_0.x,t.Vector3D.HELP_0.z),this.performer.self.changeState("Attack01",1,!0),uiManager.blood(r,1)):(this.complete=!0,this.nextNode=[this.performer.logicList.PatrolLogic]),this.time=0}}this.time+=i},i}(i);t.AttackLogic=h,__reflect(h.prototype,"egret3d.AttackLogic");var c=function(){function t(){this.targetList=[],this.logicList={},this._parallelLogic=[],this._run=!1}return t.prototype.initConfig=function(t){},t.prototype.addNode=function(t){this.logicList[t.name]=t,t.performer=this},t.prototype.startLogic=function(t){this.logicList[t]&&(this._parallelLogic.push(this.logicList[t]),this._run=!0)},t.prototype.tick=function(t,e){if(this._run){for(var i=0,r=this._parallelLogic;i<r.length;i++){var o=r[i];o.tick(t,e)}for(var n=0,a=this._parallelLogic;n<a.length;n++){var o=a[n];if(o.complete){var s=this._parallelLogic.indexOf(o);this._parallelLogic.splice(s),this.apendNext(o)}else o.tick(t,e)}}},t.prototype.apendNext=function(t){for(var e=0,i=t.nextNode;e<i.length;e++){var r=i[e];this._parallelLogic.push(r),r.complete=!1}t.nextNode.length=0},t}();t.LogicPerformer=c,__reflect(c.prototype,"egret3d.LogicPerformer");var l=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.initConfig=function(t){var e=new r;e.delayTime=6e3;var i=new o,a=new n;e.name="DelayLogic",i.name="StartGameLogic",a.name="MobLogic",this.addNode(e),this.addNode(i),this.addNode(a)},e.prototype.startLogic=function(e){t.prototype.startLogic.call(this,e)},e.prototype.tick=function(e,i){t.prototype.tick.call(this,e,i)},e}(c);t.LevelLogic=l,__reflect(l.prototype,"egret3d.LevelLogic");var g=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.initConfig=function(t){var e=new a,i=new h,r=new s;e.name="PatrolLogic",i.name="AttackLogic",r.name="MoveLogic",this.addNode(e),this.addNode(i),this.addNode(r)},e.prototype.startLogic=function(e){t.prototype.startLogic.call(this,e)},e.prototype.tick=function(e,i){t.prototype.tick.call(this,e,i)},e}(c);t.MonsterLogic=g,__reflect(g.prototype,"egret3d.MonsterLogic")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._currentMap=0}return Object.defineProperty(e.prototype,"view",{get:function(){return this._view},set:function(t){this._view=t},enumerable:!0,configurable:!0}),e.prototype.enterScene=function(e){var i="scene/"+e+"/Scene.e3dPack";this._currentScene=new t.GameScene;var r=RES.getRes(i);this._currentScene.addChild(r),this._currentScene.initEffect();var o=t.NavGrid.createNavGridFromBuffer(RES.getRes("scene/"+e+"/NavGrid.nav")),n=r.findObject3D("TerrainCollider");n&&(n.pickType=t.PickType.PositionPick,n.enablePick=!0,n.canPick=!0,this._currentScene.initTerrainCollision(n)),o&&this._currentScene.initNav(o),this._view.scene=this._currentScene},e.prototype.leaveScene=function(e){this.view.scene=new t.Scene3D,this._currentScene=null},Object.defineProperty(e.prototype,"currentScene",{get:function(){return this._currentScene},enumerable:!0,configurable:!0}),e.prototype.changeScene=function(e){var i=this;t.logicManager.sceneID=e;var r=t.TableManager.findSceneTableItem(e);r||console.log(e+" is no exist ");var o,n=t.TableManager.findWaveTableItem(r.wave_id),a=[];a.push("scene/"+r.asset_id+"/Scene.e3dPack"),a.push("scene/"+r.asset_id+"/NavGrid.nav");for(var s=["A","B","C","D"],h=0;h<s.length;h++)if(n){var c=n["monster"+s[h]+"_id"];c>0&&(o=t.TableManager.findUnitTableItem(c),o&&a.push("anim/"+o.asset_id+".e3dPack"),this.getSkillsURL(o,a))}o=t.TableManager.findUnitTableItem(1e5),a.push("anim/"+o.asset_id+".e3dPack"),this.getSkillsURL(o,a),a.push("effects/skill/FX_Hit_01.e3dPack","effects/skill/FX_Hit_02.e3dPack","effects/skill/FX_Hit_03.e3dPack","effects/skill/Fx_Levelup_01.e3dPack");var l=new LoadingPage(a,function(){i.gameMain.start(),uiManager.removePage(),uiManager.showBattle()},this);uiManager.showPage(l)},e.prototype.getSkillsURL=function(e,i){if(e)for(var r,o=0;5>o;o++){var n=e["skill_"+o.toString()+"_id"];if(n>0){r=t.TableManager.findSkillsTableItem(n);var a;if(r&&r.effect_play_name.length>0)for(var s=r.effect_play_name.split(","),h=0;h<s.length;h++)a=t.effectManager.splitUrl(s[h]),i.push(a)}}},e}();t.SceneManager=e,__reflect(e.prototype,"egret3d.SceneManager"),t.sceneManager=new e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i){var r=e.call(this)||this;return r._currIndex=0,r._moveNeedTime=0,r._pathPoints=[],r._direction=new t.Vector3D,r._targetPoint=i,r}return __extends(i,e),i.prototype.setTestCallback=function(t,e){this._callbackObj=e,this._callbackFun=t},i.prototype.resetTargetPoint=function(t){this._targetPoint=t},i.prototype.onResetAction=function(t){this.updatePathPoints(t)},i.prototype.onIsActivate=function(t){return this._pathPoints.length<=0&&this.updatePathPoints(t),this._moveNeedTime>0},i.prototype.onTick=function(e,i,r){for(var o=t.sceneManager.currentScene.nav;r>0&&!(this._currIndex>=this._pathPoints.length||e.lockMove);)if(this._moveNeedTime-=r,e.isMove=!0,e.changeState("Run",1,!1),this._moveNeedTime>=0){var n=.001*r*e.moveSpeed,a=o.xToGridX(this._pathPoints[this._currIndex].x),s=o.yToGridY(this._pathPoints[this._currIndex].z);if(0==o.isPass(a,s)&&o.getUserData(a,s)!=e.actorId){if(this.updatePathPoints(e),this._currIndex>=this._pathPoints.length)break}else o.getUserData(o.xToGridX(e.x),o.yToGridY(e.z))==e.actorId&&o.setUserData(o.xToGridX(e.x),o.yToGridY(e.z),0),e.x+=this._direction.x*n,e.z+=this._direction.z*n,0==o.getUserData(o.xToGridX(e.x),o.yToGridY(e.z))&&o.setUserData(o.xToGridX(e.x),o.yToGridY(e.z),e.actorId);r=0}else{if(r=-this._moveNeedTime,e.x=this._pathPoints[this._currIndex].x,e.z=this._pathPoints[this._currIndex].z,this._callbackFun&&(o.isPass(o.xToGridX(e.x),o.yToGridY(e.z))||o.getUserData(o.xToGridX(e.x),o.yToGridY(e.z))==e.actorId)&&0==this._callbackFun.call(this._callbackObj,this))break;if(this._currIndex+1>=this._pathPoints.length){this._moveNeedTime=0,this._currIndex=this._pathPoints.length;break}this.moveTo(e,this._pathPoints[++this._currIndex])}},i.prototype.onIsComplete=function(t){return this._moveNeedTime<=0&&this._currIndex>=this._pathPoints.length?(t.isMove=!1,t.changeState("Idle",1,!1),!0):!1},i.prototype.moveTo=function(e,i){this._moveNeedTime=t.Vector3D.distance(e.position,i)/(.001*e.moveSpeed),i.subtract(e.position,this._direction),this._direction.normalize(),e.actorTrunToDirection(this._direction.x,this._direction.z),e.isMove=!0},i.prototype.updatePathPoints=function(e){this._currIndex=0,this._moveNeedTime=0;t.sceneManager.currentScene.nav;t.sceneManager.currentScene.nav.findPath(e.position,this._targetPoint,this._pathPoints),this._pathPoints.length>0&&this.moveTo(e,this._pathPoints[this._currIndex])},i}(t.ActionNode);t.ActionMoveTo=e,__reflect(e.prototype,"egret3d.ActionMoveTo")}(egret3d||(egret3d={}));var Main=function(t){function e(){var e=t.call(this)||this,i=function(t,i){return new Promise(function(r,o){t.addEventListener(egret3d.LoaderEvent3D.LOADER_COMPLETE,function(){r(t.data)},e),t.load("resource/"+i)})};return RES.processor.map("unit",{onLoadStart:function(t,r){return __awaiter(e,void 0,void 0,function(){var t;return __generator(this,function(e){return t=new egret3d.UnitLoader,[2,i(t,r.url)]})})},onRemoveStart:function(t,i){return __awaiter(e,void 0,void 0,function(){return __generator(this,function(t){return[2,Promise.resolve()]})})}}),e.addEventListener(egret.Event.ADDED_TO_STAGE,e.onAddToStage,e),e}return __extends(e,t),e.prototype.onAddToStage=function(){egret.Capabilities.isMobile?this.stage.scaleMode=egret.StageScaleMode.FIXED_WIDTH:this.stage.scaleMode=egret.StageScaleMode.SHOW_ALL,uiManager=new UIManager(this);var t=new egret3d.Stage3D(this.stage);egret.setRendererContext(t);var e=new egret3d.Scene(t);e.createGameScene()},e}(egret.DisplayObjectContainer);Main=__decorate([RES.mapConfig("config.json",function(){return"resource"},function(t){var e=(t.substr(t.lastIndexOf(".")+1),"");if("config.json"==t)e="json";else if(t.indexOf("ui/")>=0){var i=t.substr(t.lastIndexOf(".")+1),r={jpg:"image",png:"image",webp:"image",json:"json",fnt:"font",pvr:"pvr",mp3:"sound"};e=r[i],"json"==e&&(t.indexOf("png")<0?e="sheet":t.indexOf("movieclip")>=0&&(e="movieclip"))}else e="unit";return e})],Main),__reflect(Main.prototype,"Main");var egret3d;!function(t){var e=function(t){function e(){return t.apply(this,arguments)||this}return __extends(e,t),e.prototype.onResetAction=function(t){},e.prototype.onIsActivate=function(t){return!1},e.prototype.onTick=function(t,e,i){},e.prototype.onIsComplete=function(t){return!0},e}(t.ActionNode);t.ActionParallel=e,__reflect(e.prototype,"egret3d.ActionParallel")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(e,i){var r=t.call(this)||this;return r._action=e,r._forever=0>=i,r._loopCount=i,r._isContinue=!1,r}return __extends(e,t),e.prototype.onResetAction=function(t){this._isContinue=!1,this._action.onResetAction(t)},e.prototype.onIsActivate=function(t){return this._isContinue=this._action.onIsActivate(t)},e.prototype.onTick=function(t,e,i){this._action.onTick(t,e,i),this._action.onIsComplete(t)&&(this._isContinue=!1,this._loopCount--,(this._forever||this._loopCount>0)&&(this._action.onResetAction(t),this._action.onIsActivate(t),this._isContinue=!0))},e.prototype.onIsComplete=function(t){return!this._isContinue},e}(t.ActionNode);t.ActionRepeat=e,__reflect(e.prototype,"egret3d.ActionRepeat")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(e){var i=t.call(this)||this;return i._actions=[],i._currIndex=0,i._actions=e,i._currActivate=!1,i._currAction=i._actions[i._currIndex],i}return __extends(e,t),e.prototype.onResetAction=function(t){this._currIndex=0,this._currActivate=!1,this._currAction=this._actions[this._currIndex];for(var e=0;e<this._actions.length;e++)this._actions[e].onResetAction(t)},e.prototype.onIsActivate=function(t){return!this.onIsComplete(t)},e.prototype.onTick=function(t,e,i){this._currAction&&(this._currActivate=this._currActivate||this._currAction.onIsActivate(t),this._currActivate&&(this._currAction.onTick(t,e,i),this._currAction.onIsComplete(t)&&(this._currAction=null,this._currIndex++,this._currIndex<this._actions.length&&(this._currAction=this._actions[this._currIndex],this._currActivate=this._currAction.onIsActivate(t)))))},e.prototype.onIsComplete=function(t){return this._currIndex>=this._actions.length},e}(t.ActionNode);t.ActionSequence=e,__reflect(e.prototype,"egret3d.ActionSequence")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(t){var i=e.call(this)||this;return i._attackTarget=null,i._targetPoint=t,i._actionAttackTarget=null,i}return __extends(i,e),i.prototype.onResetAction=function(t){this._attackTarget=null},i.prototype.onIsActivate=function(t){return!this.onIsComplete(t)},i.prototype.onTick=function(e,i,r){if(this._actionAttackTarget)this._actionAttackTarget.onTick(e,i,r),this._actionAttackTarget.onIsComplete(e)&&(this._attackTarget=null,this._actionAttackTarget=null);else if(this._actionMoveTo)this._actionMoveTo.onTick(e,i,r),this._actionMoveTo&&this._actionMoveTo.onIsComplete(e)&&(this._actionMoveTo=null,e.isMove=!1);else{var o=[];if(e.findNearEnemy(o),o.length>0&&t.Vector3D.distance(o[0].position,e.position)<e.itemConfig.attack_range)this._actionAttackTarget=new t.ActionAttackTarget(this._attackTarget=o[0],e.itemConfig.skill_0_id),this._actionAttackTarget.onIsActivate(e),this._actionMoveTo=null,e.isMove=!1,e.changeState("Idle",1,!1);else{var n=t.sceneManager.currentScene.nav;(n.xToGridX(e.position.x)!=n.xToGridX(this._targetPoint.x)||n.yToGridY(e.position.z)!=n.yToGridY(this._targetPoint.z))&&(this._actionMoveTo=new t.ActionMoveTo(this._targetPoint),this._actionMoveTo.onIsActivate(e),this._actionMoveTo.setTestCallback(function(){var i=[];return e.findNearEnemy(i),i.length>0&&t.Vector3D.distance(i[0].position,e.position)<e.itemConfig.attack_range?(this._actionAttackTarget=new t.ActionAttackTarget(this._attackTarget=i[0],e.itemConfig.skill_0_id),this._actionAttackTarget.onIsActivate(e),this._actionMoveTo=null,e.isMove=!1,e.changeState("Idle",1,!1),!1):!0},this))}}},i.prototype.onIsComplete=function(e){if(this._attackTarget)return!1;if(t.Vector3D.distance(e.position,this._targetPoint)>24)return!1;var i=[];return e.findNearEnemy(i),i.length>0&&t.Vector3D.distance(i[0].position,e.position)<e.itemConfig.attack_range?!1:(e.isMove=!1,!0)},i}(t.ActionNode);t.ActionAttackTo=e,__reflect(e.prototype,"egret3d.ActionAttackTo")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.strength=0,this.agility=0,this.intelligence=0,this.hp=0,this.max_hp=0,this.mp=0,this.max_mp=0,this.attack=0,this.defense=0,this.crit=0,this.exp=0,this.level=1,this.isCrit=!1,this.critDamage=0,this.attack_speed=0,this.attack_range=0,this.moveSpeed=0,this.healingRate=0,this.manarate=0}return t.prototype.initData=function(t){this.data=t,this.strength=t.strength,this.agility=t.agility,this.intelligence=t.intelligence,this.exp=0,this.level=t.level,this.update(),this.hp=this.max_hp},t.prototype.update=function(){var t=this;t.max_hp=25*t.strength,t.healingRate=.05*t.strength,"strength"==t.data.primettribute&&(t.attack=t.strength),t.defense=.3*t.agility,t.attack_speed=t.data.attack_speed+.1*t.agility*.1,t.critDamage=.02*t.agility,t.crit=.11*t.agility,t.moveSpeed=t.data.moveSpeed+.3*t.moveSpeed,"agility"==t.data.primettribute&&(t.attack=t.agility),t.max_mp=15*t.intelligence,t.manarate=.05*t.intelligence,"intelligence"==t.data.primettribute&&(t.attack=t.intelligence),t.hp=t.max_hp,t.mp=t.max_mp},t}();t.ActorData=e,__reflect(e.prototype,"egret3d.ActorData");var i=function(){function t(){this.animCount=0}return t}();t.StateStruct=i,__reflect(i.prototype,"egret3d.StateStruct");var r=function(r){function o(){var i=r.call(this)||this;i.animMoveSpeed=1,i.animLock=!1,i.lookObj=new t.Object3D,i.groupID=0,i.distance=0,i.useLookJoint=!1,i.states={},i.actorId=++o._globalCount,i.actorData=new e,i.detailActorData=new e,i.lockMove=!1,i.lockSkills=!1;var n=RES.getRes("ShadowPlane.png");return i.shadow=new t.Mesh(new t.PlaneGeometry(150,150,1,1),new t.TextureMaterial(n)),i.shadow.tag.name="decal",i.addChild(i.shadow),i.shadow.y=10,i.shadow.material.blendMode=t.BlendMode.ALPHA,i.shadow.material.alpha=.7,i._hpRestoreTime=1e3,i}return __extends(o,r),o.prototype.onBeAdded=function(){this._titleView.visible=!0,this.lockMove=!1},o.prototype.onBeRemove=function(){if(this._titleView.visible=!1,t.sceneManager.currentScene){var e=t.sceneManager.currentScene.nav;e.getUserData(e.xToGridX(this.x),e.yToGridY(this.z))==this.actorId&&e.setUserData(e.xToGridX(this.x),e.yToGridY(this.z),0)}},o.prototype.rebirth=function(){this.runAction(null),this.actorData.hp=this.actorData.max_hp,this.detailActorData.hp=this.detailActorData.max_hp,this.role.skeletonAnimation.play("Idle"),this.updateActorData()},o.prototype.getNumbers=function(t){for(var e=t.split(","),i=[],r=0;r<e.length;r++)i.push(Number(e[r]));return i},o.prototype.initConfig=function(){for(var e=[t.TableManager.findSkillsTableItem(this.itemConfig.skill_0_id),t.TableManager.findSkillsTableItem(this.itemConfig.skill_1_id),t.TableManager.findSkillsTableItem(this.itemConfig.skill_2_id),t.TableManager.findSkillsTableItem(this.itemConfig.skill_3_id),t.TableManager.findSkillsTableItem(this.itemConfig.skill_4_id)],r=0;r<e.length;r++){var o=e[r];if(o){var n=new i;n.id=o.id,n.animStates=o.animation_name.split(","),n.reset=!0,n.speed=o.speed,n.effects=""==o.effect_play_name?[]:o.effect_play_name.split(","),n.effectTimes=this.getNumbers(o.effect_play_delay),n.audios=""==o.sound_name?[]:o.sound_name.split(","),n.audioTimes=this.getNumbers(o.sound_play_delay),this.states[n.id]=n}}},o.prototype.cast=function(e,i){var r=this.castState;if(r=this.states[e]){r.animCount+1>=r.animStates.length?r.animCount=0:r.animCount++,this.changeState(r.animStates[r.animCount],r.speed*this.actorData.attack_speed>=1?r.speed*this.actorData.attack_speed:1,r.reset);for(var o=0;o<r.effects.length;o++){var n=o;t.timemer.timing(r.effectTimes[o],this.playSkill_effect,this,r,n)}for(var o=0;o<r.audios.length;o++)t.timemer.timing(r.audioTimes[o],this.playAudio,this,r.audios[o])}},o.prototype.hit=function(e){var i=this;if(!(i.itemConfig.hit_effect_bone.length<=0)){var r=t.effectManager.getEffect(e);if(r){var o=t.gameCameraManager.currentCamera;r.play(1,!0),i.parent.addChild(r),i.position.subtract(o.position,t.Vector3D.HELP_0),t.Vector3D.HELP_0.normalize(),t.Vector3D.HELP_0.scaleBy(100),r.x=-t.Vector3D.HELP_0.x+i.x+i.lookObj.x,r.y=-t.Vector3D.HELP_0.y+i.y+i.lookObj.y,r.z=-t.Vector3D.HELP_0.z+i.z+i.lookObj.z}}},o.prototype.playAudio=function(t){audio.audioManager.play("resource/sound/"+t)},o.prototype.playSkill_effect=function(e,i){var r=e.effects[i],o=t.effectManager.getEffect(r);o&&(o.play(e.speed,!0),o.x=this.performer.self.x,o.y=this.performer.self.y,o.z=this.performer.self.z,o.rotationY=this.performer.self.rotationY,this.performer.self.parent.addChild(o))},o.prototype.playEffect=function(e,i){var r=t.effectManager.getEffect(e);r&&(r.play(i,!0),r.x=this.performer.self.x,r.y=this.performer.self.y,r.z=this.performer.self.z,r.rotationY=this.performer.self.rotationY,this.performer.self.parent.addChild(r))},o.prototype.updateActorData=function(){var t=!1,e=this.detailActorData.hp,i=this.detailActorData.mp;return 0!=e&&(this._hpBar.ratio=this.actorData.hp/this.actorData.max_hp,e>0&&(uiManager.blood(this,e),t=!0)),i&&(t=!0),t},Object.defineProperty(o.prototype,"isDeath",{get:function(){return this.actorData.hp<=0},enumerable:!0,configurable:!0}),o.prototype.start=function(){},o.prototype.setRole=function(e,i){if(this.lockSkills=!1,this.itemConfig=i,this.upgradeConfig=i.upgrade_id>0?t.TableManager.findUpgradeTableItem(i.upgrade_id):null,this.initConfig(),this.actorData.initData(i),this.detailActorData.initData(i),this.name=i.name,this.moveSpeed=this.actorData.moveSpeed,this._hpRestoreTime=1e3,e){this.role=e,this.addChild(this.role);for(var r in e.avatar)e.avatar[r].lightGroup=this.lights,e.avatar[r].scaleX=e.avatar[r].scaleY=e.avatar[r].scaleZ=i.scale_ratio;this.role.skeletonAnimation.play("Idle"),this.lookJoint=this.role.skeletonAnimation.state.gpuSkeletonPose.jointsDictionary[i.hit_effect_bone],this.lookJoint&&this.role.skeletonAnimation.addEventListener(t.AnimationEvent3D.COMPLETE,this.animComplete,this)}this._titleView=new egret.Sprite,0===this.groupID?this._hpBar=new ProcessBar("ui/gameUI.json#hpbar_bg.png","ui/gameUI.json#hpbar_pet.png"):this._hpBar=new ProcessBar("ui/gameUI.json#hpbar_bg.png","ui/gameUI.json#hpbar_jun.png"),this._hpBar.width=80,this._hpBar.height=8,this._titleView.addChild(this._hpBar),this._lvNameText=new egret.TextField,this._lvNameText.textColor=16777215,this._lvNameText.text="lv: "+this.actorData.level+" "+this.itemConfig.name,this._lvNameText.width=100,this._lvNameText.height=20,this._lvNameText.size=20,this._lvNameText.y=-this._lvNameText.height-5,this._titleView.addChild(this._lvNameText),uiManager.addHpBar(this,this._titleView),this.updateActorData()},o.prototype.addExp=function(e){for(;this.upgradeConfig&&e>0&&(this.actorData.exp+=e,!(this.actorData.exp<this.upgradeConfig.upgrade_exp));)e=this.actorData.exp-this.upgradeConfig.upgrade_exp,this.actorData.exp=0,++this.actorData.level,this.playEffect("Fx_Levelup_01",1),this._lvNameText.text="lv: "+this.actorData.level+" "+this.itemConfig.name,this.actorData.strength=this.upgradeConfig.strength,this.actorData.agility=this.upgradeConfig.agility,this.actorData.intelligence=this.upgradeConfig.intelligence,this.actorData.update(),this.upgradeConfig=this.upgradeConfig.next_id>0?t.TableManager.findUpgradeTableItem(this.upgradeConfig.next_id):null;this.upgradeConfig?uiManager.updateExpBar(this.actorData.exp/this.upgradeConfig.upgrade_exp):uiManager.updateExpBar(1)},o.prototype.animComplete=function(t){this.animLock=!1},o.prototype.changeState=function(t,e,i,r){void 0===e&&(e=1),void 0===i&&(i=!1),void 0===r&&(r=!1),this.useLookJoint=r,this.role&&this.role.skeletonAnimation.play(t,e,i),i&&(this.animLock=!0)},o.prototype.update=function(t,e,i){return this.gameRoom.isGameOver?void(this.isDeath||this.changeState("Idle",1,!1)):this.isDeath?void this.changeState("Death",1,!1):(this.animLock||(this.isMove?this.changeState("Run",1,!1):this.changeState("Idle",1,!1)),this.lookJoint&&(this.lookJoint.copyTo(this.lookObj),this.lookObj.x=-this.lookObj.x,this.lookObj.z=-this.lookObj.z),this._action&&!this.isDeath&&(this==this.gameRoom.gameController.mainActor&&(this._hpRestoreTime-=e,this._hpRestoreTime<=0&&(this._hpRestoreTime+=1e3,this.actorData.hp+=Math.min(this.actorData.healingRate,this.actorData.max_hp-this.actorData.hp),this._hpBar.ratio=this.actorData.hp/this.actorData.max_hp)),this._action.onTick(this,t,e),this._action.onIsComplete(this)&&(this._action=null)),void r.prototype.update.call(this,t,e,i))},o.prototype.runAction=function(t){t?t.onIsActivate(this)&&(this._action=t):this._action=null},o.prototype.findNearEnemy=function(e,i){void 0===i&&(i=-1),e.length=0,i=0>=i?this.itemConfig.attack_range:i;for(var r=0,o=this.gameRoom.actorlist;r<o.length;r++){var n=o[r];if(!n.isDeath&&this!=n&&n.groupID!=this.groupID){var a=t.Vector3D.distance(this.position,n.position);i>a&&e.push(n)}}return e},o}(Actor);r._globalCount=0,t.GameActor=r,__reflect(r.prototype,"egret3d.GameActor")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,r,o,n){void 0===o&&(o=10),void 0===n&&(n=2);var a,s=r.length>2?Math.floor(r.length/2)+1:1,h=new t.PlaneGeometry(0,0,o,s,1,1,t.Vector3D.Y_AXIS);return null===i&&(i=new t.TextureMaterial),a=e.call(this,h,i)||this,a.segmentRibbon=n,a.material.ambientColor=0,a._segmentH=h.segmentsH,a._segmentW=h.segmentsW,a.material.blendMode=t.BlendMode.SOFT_ADD,a.material.ambientColor=4294967295,a.material.bothside=!0,a._vecs=r,a._autoUpdate=!0,a.initVertex(),a._temp_v0=new t.Vector3D,a._temp_v1=new t.Vector3D,a
}return __extends(i,e),Object.defineProperty(i.prototype,"autoUpdate",{set:function(t){this._autoUpdate=t},enumerable:!0,configurable:!0}),i.prototype.updateVertices=function(){var e=this.geometry;this.showNewTrail(),e.upload(t.Egret3DCanvas.context3DProxy)},i.prototype.showNewTrail=function(){for(var t=[],e=this._segmentW+1,i=this._vecs.length,r=0;i>r;r++)t.push(this._vecs[r].globalPosition);for(var o,n=this.getVerticeDataByCol(0),r=0;r<this.segmentRibbon;r++){for(var a=[],s=0;i>s;s++)o=3*s,this._temp_v0.x=n[o],this._temp_v0.y=n[o+1],this._temp_v0.z=n[o+2],this._temp_v1.slerp(this._temp_v0,t[s],(r+1)/this.segmentRibbon),a.push(this._temp_v1.x),a.push(this._temp_v1.y),a.push(this._temp_v1.z);for(var h,c=0;e>c;c++)h=this.getVerticeDataByCol(c),this.setVerticesDataByCol(c,a),a=h}},i.prototype.update=function(t,i,r){if(this._autoUpdate){var o=(new Date).getTime();this.updateVertices(),console.log("更新刀光顶点耗时: ",(new Date).getTime()-o)}e.prototype.update.call(this,t,i,r)},i.prototype.setVerticesDataByCol=function(t,e){var i,r,o=this.geometry.indexArray,n=this.geometry.vertexArray,a=this.geometry.vertexAttLength,s=t+t-1;0>s&&(s=0),i=0===t?o[0]:o[3*t+3*(t-1)+1],r=i*a,n[r]=e[0],n[r+1]=e[1],n[r+2]=e[2];for(var h,c=this._segmentW+this._segmentW,l=this._segmentH,g=0;l>g;g++)i=o[3*(g*c+s)+2],r=i*a,h=3*(g+1),n[r]=e[h],n[r+1]=e[h+1],n[r+2]=e[h+2]},i.prototype.getVerticeDataByCol=function(t){var e,i,r=[],o=this.geometry.indexArray,n=this.geometry.vertexArray,a=this.geometry.vertexAttLength,s=t+t-1;0>s&&(s=0),e=0===t?o[0]:o[3*t+3*(t-1)+1],i=e*a,r=r.concat([n[i],n[i+1],n[i+2]]);for(var h=this._segmentW+this._segmentW,c=this._segmentH,l=0;c>l;l++)e=o[3*(l*h+s)+2],i=e*a,r=r.concat([n[i],n[i+1],n[i+2]]);return r},i.prototype.initVertex=function(){for(var e=[],i=0;i<this._vecs.length;i++)e.push(this._vecs[i].globalPosition.x),e.push(this._vecs[i].globalPosition.y),e.push(this._vecs[i].globalPosition.z);for(var r=this._segmentW,i=0;r>i;i++)this.setVerticesDataByCol(i,e);this.geometry.upload(t.Egret3DCanvas.context3DProxy)},i}(t.Mesh);t.Ribbon=e,__reflect(e.prototype,"egret3d.Ribbon")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.prototype.start=function(){t.logicManager.start(),t.effectManager.start()},e.prototype.update=function(e,i){t.sceneManager.currentScene&&(t.logicManager.update(e,i),uiManager.updateBattle(e,i),t.effectManager.update(e,i))},e.prototype.onResize=function(){},e}();t.GameMain=e,__reflect(e.prototype,"egret3d.GameMain")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(t){function e(e){var i=t.call(this)||this;return i._delay_time=0,i._delay=e,i._delay_time=i._delay,i}return __extends(e,t),e.prototype.onResetAction=function(t){this._delay_time=this._delay},e.prototype.onIsActivate=function(t){return this._delay_time>0},e.prototype.onTick=function(t,e,i){this._delay_time-=i},e.prototype.onIsComplete=function(t){return this._delay_time<=0},e}(t.ActionNode);t.ActionDelay=e,__reflect(e.prototype,"egret3d.ActionDelay")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){this.time=0,this.timeID=0}return t}();t.TimeNode=e,__reflect(e.prototype,"egret3d.TimeNode");var i=function(){function t(){}return t.prototype.timing=function(t,i,r){for(var o=[],n=3;n<arguments.length;n++)o[n-3]=arguments[n];var a=new e;a.timeID=setTimeout(function(){return i.call.apply(i,[r].concat(o))},t)},t}();t.Tween=i,__reflect(i.prototype,"egret3d.Tween"),t.timemer=new i;var r=function(e){function i(){var t=e.call(this)||this;return t.aiRadius=1500,t.isLongRange=!1,t.attackRange=280,t.keepMinRange=180,t.tickTime=1001,t.tickCycle=1e3,t.eventTime=-1,t.isParallel=!1,t}return __extends(i,e),i.prototype.getNear=function(){for(var e,i=this.aiRadius,r=0,o=this.performer.gameRoom.actorlist;r<o.length;r++){var n=o[r];if(this.performer.self!=n&&n.groupID!=this.performer.self.groupID){var a=t.Vector3D.distance(this.performer.self.position,n.position);i>a&&(i=a,n.distance=a,e=n)}}return e},i.prototype.getNearPoint=function(e){var i=360*Math.random(),r=Math.sin(i)*this.keepMinRange+e.position.x,o=Math.cos(i)*this.keepMinRange+e.position.z;return t.Vector3D.HELP_0.x=r,t.Vector3D.HELP_0.z=o,t.Vector3D.HELP_0},i.prototype.tick=function(t,e){if(this.tickTime>this.tickCycle){this.tickTime=0;var i=this.getNear();if(i&&1!=i.groupID&&i.groupID!=this.performer.self.groupID){var r=i.distance;if(r<this.aiRadius)if(r<=this.attackRange&&r>this.keepMinRange-32&&r<this.keepMinRange+32)this.nextNode=[this.performer.logicList.AttackLogic],this.performer.targetList.push(i),this.performer.targetList=[i],this.complete=!0;else{var o=this.getNearPoint(i),n=this.performer.logicList.MoveLogic;n.move(o),this.performer.targetList=[i],this.nextNode=[n],this.complete=!0}else this.performer.targetList.length=0}}this.tickTime+=e},i}(t.LogicNode);t.ProPatrolLogic=r,__reflect(r.prototype,"egret3d.ProPatrolLogic");var o=function(e){function i(){var i=e.call(this)||this;return i.targetPos=new t.Vector3D,i.tickDelay=160,i.time=0,i.eventTime=-1,i.isParallel=!1,i}return __extends(i,e),i.prototype.move=function(t){this.targetPos.copyFrom(t),this.performer.self.actorMoveTo(this.targetPos.x,0,this.targetPos.z)},i.prototype.tick=function(t,e){this.time>this.tickDelay&&(this.performer.self.isMove?this.move(this.targetPos):(this.complete=!0,this.nextNode=[this.performer.logicList.PatrolLogic],this.performer.self.actorTrunToDirection(this.targetPos.x,this.targetPos.z)),this.time=0),this.time+=e},i}(t.LogicNode);t.ProMoveLogic=o,__reflect(o.prototype,"egret3d.ProMoveLogic");var n=function(e){function i(){var t=e.call(this)||this;return t.time=0,t.eventTime=-1,t.isParallel=!1,t}return __extends(i,e),i.prototype.tick=function(t,e){this.complete||(this.tickOnce(),this.complete=!0)},i.prototype.tickOnce=function(){var e=t.effectManager.getEffect("FX_Hit_03"),i=t.gameCameraManager.currentCamera;e&&(e.play(1,!0),this.performer.targetList[0].parent.addChild(e),this.performer.targetList[0].position.subtract(i.position,t.Vector3D.HELP_0),t.Vector3D.HELP_0.normalize(),t.Vector3D.HELP_0.scaleBy(100),e.x=-t.Vector3D.HELP_0.x+this.performer.targetList[0].x,e.y=-t.Vector3D.HELP_0.y+this.performer.targetList[0].y,e.z=-t.Vector3D.HELP_0.z+this.performer.targetList[0].z)},i}(t.LogicNode);t.ProHitLogic=n,__reflect(n.prototype,"egret3d.ProHitLogic");var a=function(e){function i(){var t=e.call(this)||this;return t.time=2e3,t.eventTime=-1,t.isParallel=!1,t}return __extends(i,e),i.prototype.tick=function(e,i){if(this.performer.targetList.length>0){this.player=this.performer.self.itemConfig;var r=this.performer.targetList[0];if(this.time>2*this.player.attack_speed){var o=t.Vector3D.distance(this.performer.self.position,r.position);if(280>o){t.Vector3D.HELP_0.x=-(this.performer.self.x-r.position.x),t.Vector3D.HELP_0.z=-(this.performer.self.z-r.position.z),t.Vector3D.HELP_0.normalize(),this.performer.self.actorTrunToDirection(t.Vector3D.HELP_0.x,t.Vector3D.HELP_0.z);var n=Math.floor(5*Math.random());switch(n){case 0:this.cast_skill1();break;case 1:this.cast_skill2();break;case 2:this.cast_skill3();break;case 3:this.cast_skill4();break;case 4:this.normalAttack()}uiManager.blood(r,1)}else this.complete=!0,this.nextNode.push(this.performer.logicList.PatrolLogic);this.time=0}}this.time+=i},i.prototype.normalAttack=function(){this.playAudio("player/Swish_Knife_06.wav"),this.performer.self.changeState("Attack01",1,!0)},i.prototype.cast_skill1=function(){this.playAudio("player/Executor_chop.wav"),this.performer.self.changeState("Skill01",1,!0)},i.prototype.cast_skill2=function(){this.performer.self.changeState("Skill02",1,!0)},i.prototype.cast_skill3=function(){this.performer.self.changeState("Skill03",1,!0),this.playAudio("player/Executor_earthquake.wav")},i.prototype.cast_skill4=function(){this.performer.self.changeState("Skill04",1,!0)},i.prototype.playAudio=function(t){audio.audioManager.play("resource/sound/"+t)},i.prototype.playSkill_effect=function(e,i){var r=t.effectManager.getEffect(e);r&&(r.play(i,!0),r.x=this.performer.self.x,r.y=this.performer.self.y,r.z=this.performer.self.z,r.rotationY=this.performer.self.rotationY,this.performer.self.parent.addChild(r))},i.prototype.activeHit=function(){},i}(t.LogicNode);t.ProAttackLogic=a,__reflect(a.prototype,"egret3d.ProAttackLogic");var s=function(t){function e(){var e=t.call(this)||this;return e._immediatelyNodes=[],e}return __extends(e,t),e.prototype.initConfig=function(t){},e.prototype.addNode=function(t){this.logicList[t.name]=t,t.performer=this},e.prototype.startLogic=function(t){this.logicList[t]&&(this._parallelLogic.push(this.logicList[t]),this._run=!0)},e.prototype.tick=function(t,e){if(this._run){for(var i=0,r=this._parallelLogic;i<r.length;i++){var o=r[i];if(o.complete){var n=this._parallelLogic.indexOf(o);this._parallelLogic.splice(n),this.apendNext(o)}else this.apendImmediately(o)}for(var a=0,s=this._immediatelyNodes;a<s.length;a++){var o=s[a];o.complete||this.apendImmediately(o)}for(var h=0,c=this._parallelLogic;h<c.length;h++){var o=c[h];o.tick(t,e)}for(var l=0,g=this._immediatelyNodes;l<g.length;l++){var o=g[l];o.tick(t,e)}}},e.prototype.apendNext=function(t){for(var e=0,i=t.nextNode;e<i.length;e++){var r=i[e];this._parallelLogic.push(r),r.complete=!1}t.nextNode.length=0},e.prototype.apendImmediately=function(t){for(var e=0,i=t.immediatelyNodes;e<i.length;e++){var r=i[e];this._immediatelyNodes.push(r),r.complete=!1}t.immediatelyNodes.length=0},e}(t.LogicPerformer);t.ProLogicPerformer=s,__reflect(s.prototype,"egret3d.ProLogicPerformer");var h=function(t){function e(){return t.call(this)||this}return __extends(e,t),e.prototype.initConfig=function(t){var e=new r;this.proAttackLogic=new a;var i=new o,s=new n;e.name="PatrolLogic",this.proAttackLogic.name="AttackLogic",i.name="MoveLogic",s.name="ProHitLogic",this.addNode(e),this.addNode(this.proAttackLogic),this.addNode(i),this.addNode(s)},e.prototype.startLogic=function(e){t.prototype.startLogic.call(this,e)},e.prototype.tick=function(e,i){t.prototype.tick.call(this,e,i)},e}(s);t.ProtagonistLogic=h,__reflect(h.prototype,"egret3d.ProtagonistLogic")}(egret3d||(egret3d={}));var audio;!function(t){var e=function(){function t(){this._tables={},this._source={}}return t.prototype.play=function(t,e){void 0===e&&(e=!1)},t.prototype.recover=function(t,e,i){void 0===i&&(i=!1);var r=this;if(!i){var o=t.getDuration();r._tables[e]||(r._tables[e]=new Array),setTimeout(function(){r._tables[e].push(t)},1e3*o)}},t.prototype.findfreeChannel=function(t){var e,i=this._tables[t];return i&&i.length>0&&(e=i.pop()),e},t}();t.AudioManager=e,__reflect(e.prototype,"audio.AudioManager"),t.audioManager=new e}(audio||(audio={}));var egret3d;!function(t){var e=function(){function t(){}return t}();__reflect(e.prototype,"AnimNode");var i=function(){function t(){this._ctl=new r}return t.prototype.playCameraAnim=function(t){},Object.defineProperty(t.prototype,"currentCamera",{get:function(){return this._camera},set:function(t){this._camera=t,this._ctl.camera=t},enumerable:!0,configurable:!0}),t.prototype.follow=function(t){this._ctl.lookAt(t)},t.prototype.update=function(t,e){this._ctl.update(t,e)},t}();t.GameCameraManager=i,__reflect(i.prototype,"egret3d.GameCameraManager");var r=function(){function e(){this._height=400,this._tiltAngle=60,this._offsetZ=0,this.height=1e3,this.tiltAngle=50}return Object.defineProperty(e.prototype,"camera",{set:function(t){this._camera=t},enumerable:!0,configurable:!0}),e.prototype.lookAt=function(t){this._target=t},Object.defineProperty(e.prototype,"height",{set:function(t){this._height=t,this.notifeUpdate()},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"tiltAngle",{set:function(t){this._tiltAngle=t,this.notifeUpdate()},enumerable:!0,configurable:!0}),e.prototype.update=function(t,e){this._target&&(this._camera.rotationX=this._tiltAngle,this._camera.x=this._target.x,this._camera.y=this._target.y+this._height,this._camera.z=this._target.z-this._offsetZ)},e.prototype.notifeUpdate=function(){this._offsetZ=this._height/Math.tan(this._tiltAngle*t.MathUtil.DEGREES_TO_RADIANS)},e}();__reflect(r.prototype,"ThirdCameraController"),t.gameCameraManager=new i}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this._effectCount=0,this._effectNames=[],this._busyEffects=new t.DoubleArray,this._freeEffects=new t.DoubleArray,this._orignalEffects={},this._uploadStatus=-1,this._preEffects={},this._recycleTime={Fx_Skill1:1200,Fx_Skill2_1:1200,Fx_Skill2_2:1200,Fx_Skill2_3:1500,Fx_Skill3_1:2e3,Fx_Skill4:2500,FX_Hit_01:500,FX_Hit_02:500,FX_Hit_03:500,Fx_Levelup_01:2e3},this._prepareCount={Fx_Skill1:1,Fx_Skill2_1:1,Fx_Skill2_2:1,Fx_Skill2_3:1,Fx_Skill3_1:1,Fx_Skill4:1,FX_Hit_01:2,FX_Hit_02:2,FX_Hit_03:2,Fx_Levelup_01:1}}return e.prototype.start=function(){this.preUpload(),this.prepareEffects()},e.prototype.splitUrl=function(t){var e="effects/skill/"+t+".e3dPack";return e},e.prototype.getEffect=function(t){-1==this._effectNames.indexOf(t)&&(this._effectNames.push(t),this._effectCount++);var e,i=this._freeEffects.getValueByKey(t);if(i&&i.length>0)e=i.shift();else{if(e=this._orignalEffects[t],null==e){var r=this.splitUrl(t);e=RES.getRes(r),this._orignalEffects[t]=e}else e=e.deepClone(),e.isOriginal=!1;if(null==e)return null}var o=this._busyEffects.getValueByKey(t);return null==o&&(o=[],this._busyEffects.put(t,o)),o.push(e),e.liveTime=0,e},e.prototype.recycleEffect=function(t,e){e.stop(),e.parent&&(e.parent.removeChild(e),e.x=e.y=e.z=0),e.liveTime=-1;var i=this._freeEffects.getValueByKey(t);null==i&&(i=[],this._freeEffects.put(t,i)),i.push(e);var r=this._busyEffects.getValueByKey(t);if(r){var o=r.indexOf(e);o>=0&&r.splice(o,1)}},e.prototype.recycleAllEffect=function(){for(var t,e,i=0;i<this._effectCount;i++){t=this._effectNames[i];var r=this._busyEffects.getValueByKey(t);if(null!=r)for(var o=r.length-1;o>=0;o--)e=r[o],this.recycleEffect(t,e)}},e.prototype.update=function(t,e){for(var i,r,o=3e3,n=0,a=!1,s=0;s<this._effectCount;s++){i=this._effectNames[s];for(var h=this._busyEffects.getValueByKey(i),c=this._recycleTime[i]||o,l=h.length-1;l>=0;l--)r=h[l],r.liveTime+=e*r.speed,r.liveTime>=c?(this.recycleEffect(i,r),a=!0):n++}this._uploadStatus>=0&&(this._uploadStatus>=1?this.removePreUpload():this._uploadStatus++)},e.prototype.preUpload=function(){this._uploadStatus=0;for(var e,i,r=["Fx_Skill1","Fx_Skill2_1","Fx_Skill2_2","Fx_Skill2_3","Fx_Skill3_1","Fx_Skill4","FX_Hit_01","FX_Hit_02","FX_Hit_03","Fx_Levelup_01"],o=new t.Vector3D(2300,10,1400),n=0,a=r.length;a>n;n++)e=r[n],i=this.getEffect(e),i&&(this._preEffects[e]=i,i.position=o,t.sceneManager.currentScene.addChild(i))},e.prototype.removePreUpload=function(){var t,e;for(t in this._preEffects)e=this._preEffects[t],this.recycleEffect(t,e);this._preEffects={},this._uploadStatus=-1},e.prototype.prepareEffects=function(){},e}();t.EffectManager=e,__reflect(e.prototype,"egret3d.EffectManager"),t.effectManager=new e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){this.sceneID=1e5,this.cancelMove=!1,this._localStorageData={}}return e.prototype.getLocalStorageItem=function(t){try{return localStorage.getItem(t)}catch(e){return this._localStorageData[t]||""}},e.prototype.setLocalStorageItem=function(t,e){try{localStorage.setItem(t,e)}catch(i){this._localStorageData[t]=e}},e.prototype.initGrassSqueeze=function(){RES.getRes("scene/scene_0/MapConfig.json")},e.prototype.startGameRoom=function(){this.currentGameRoom=new o,this.currentGameRoom.useMap(this.sceneID);var e=this.currentGameRoom.addRole(1e5,0,!0);e.performer=e.performer||new t.ProtagonistLogic,e.performer.self=e,e.performer.gameRoom=this.currentGameRoom,e.performer.initConfig(null),e.performer.startLogic("PatrolLogic"),this.currentGameRoom.start()},e.prototype.start=function(){this.startGameRoom()},e.prototype.exit=function(){this.currentGameRoom.closeGameRoom(),t.sceneManager.leaveScene(t.sceneManager.currentScene),uiManager.leaveBattle(),uiManager.showPage(new RoomPage)},e.prototype.update=function(t,e){this.currentGameRoom&&this.currentGameRoom.update(t,e)},e}();t.LogicManager=e,__reflect(e.prototype,"egret3d.LogicManager");var i=function(e){function i(){return e.call(this)||this}return __extends(i,e),i.prototype.initEffect=function(){this._lineFog=new t.LineFogMethod,this._lineFog.fogFarDistance=1400,this._lineFog.fogStartDistance=3e3,this._lineFog.fogColor=t.Color.RGBAToColor(0,192/255,1,1),this._lineFog.fogAlpha=1,this.addFog(this)},i.prototype.addFog=function(e){for(var i in e.childs)e.childs[i]instanceof t.Mesh?e.childs[i].material.diffusePass.addMethod(this._lineFog):this.addFog(e.childs[i])},i.prototype.initTerrainCollision=function(t){this.terrainMesh=t},i.prototype.initNav=function(t){this._nav=t},i.prototype.getTerrainHeight=function(t,e){return this._terrainCollision?this._terrainCollision.getTerrainCollisionHeight(t,e):0},Object.defineProperty(i.prototype,"nav",{get:function(){return this._nav},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"terrainCollision",{get:function(){return this._terrainCollision},enumerable:!0,configurable:!0}),i}(t.Scene3D);t.GameScene=i,__reflect(i.prototype,"egret3d.GameScene");var r=function(){function e(){this._monsterNum=[0,0,0,0,0],this._refreshMonsterTimer=0,this._event3D=new t.Event3D}return e.prototype.start=function(e){var i=this;this._gameRoom=e,this._sceneItem=e.sceneItem,this._waveItem=t.TableManager.findWaveTableItem(this._sceneItem.wave_id);var r=t.JSON_Util.getVector3D(this._sceneItem.host_point);this.host=e.addRole(this._sceneItem.host_unit_id,0,!1),this.host.jumpTo(r.x,r.z),clearTimeout(this._refreshMonsterTimer),this._refreshMonsterTimer=setTimeout(function(){return i.onRefreshMonster()},this._sceneItem.start_wait)},e.prototype.onRefreshMonster=function(){for(var e=this,i=[this._waveItem.monsterA_id,this._waveItem.monsterB_id,this._waveItem.monsterC_id,this._waveItem.monsterD_id,this._waveItem.monsterE_id],r=[this._waveItem.monsterA_num,this._waveItem.monsterB_num,this._waveItem.monsterC_num,this._waveItem.monsterD_num,this._waveItem.monsterE_num],o=[this._gameRoom.sceneItem.monster_point_0,this._gameRoom.sceneItem.monster_point_1,this._gameRoom.sceneItem.monster_point_2,this._gameRoom.sceneItem.monster_point_3,this._gameRoom.sceneItem.monster_point_4],n=(t.JSON_Util.getVector3D(this._gameRoom.sceneItem.host_point),i.length-1);n>=0;n--)if(i[n]>0&&this._monsterNum[n]<r[n]){var a=t.JSON_Util.getVector3D(o[n]),s=this._gameRoom.addRole(i[n],2,!1);s.jumpTo(a.x,a.z),s.runAction(new t.ActionRepeat(new t.ActionSequence([new t.ActionAttackTo(t.JSON_Util.getVector3D(this._gameRoom.sceneItem.host_point)),new t.ActionDelay(400)]),-1)),this._monsterNum[n]++}this._monsterNum[0]>=this._waveItem.monsterA_num&&this._monsterNum[1]>=this._waveItem.monsterB_num&&this._monsterNum[2]>=this._waveItem.monsterC_num&&this._monsterNum[3]>=this._waveItem.monsterD_num&&this._monsterNum[4]>=this._waveItem.monsterE_num?(this._waveItem.next_wave>0?(this._waveItem=t.TableManager.findWaveTableItem(this._waveItem.next_wave))&&(this._monsterNum[0]=this._monsterNum[1]=this._monsterNum[2]=this._monsterNum[3]=this._monsterNum[4]=0):this._waveItem=null,clearTimeout(this._refreshMonsterTimer),this._refreshMonsterTimer=setTimeout(function(){return e.onCheckMonster()},3e3)):(clearTimeout(this._refreshMonsterTimer),this._refreshMonsterTimer=setTimeout(function(){return e.onRefreshMonster()},1e3))},e.prototype.onCheckMonster=function(){var e=this;this.host.isDeath||(this._gameRoom.getActorNumFromGroupID(2)<=0?this._waveItem?this.onRefreshMonster():(t.logicManager.setLocalStorageItem(this._sceneItem.next_scene_id.toString(),"false"),this._gameRoom.gameOver()):(clearTimeout(this._refreshMonsterTimer),this._refreshMonsterTimer=setTimeout(function(){return e.onCheckMonster()},3e3)))},e}();t.GameLevel=r,__reflect(r.prototype,"egret3d.GameLevel");var o=function(e){function i(){var i=e.call(this)||this;return i.monsterItem=[],i.gPoint=new t.Vector3D,i.actorlist=[],i._event3D=new t.Event3D,i.gameController=new n,i._gameLevel=new r,i._mainActorIsDeath=!1,i.isGameOver=!1,i}return __extends(i,e),i.prototype.start=function(){var e=t.JSON_Util.getVector3D(this.sceneItem.player_point);this.setStartPosition(e.x,e.z),this._gameLevel.start(this),this._mainActorIsDeath=!1,this._crystalMesh=t.sceneManager.currentScene.findObject3D("Crystal"),this.isGameOver=!1,uiManager.startTimeKeeper()},i.prototype.closeGameRoom=function(){for(var t=0,e=this.actorlist;t<e.length;t++){var i=e[t];this.removeRole(i)}},i.prototype.getActorNumFromGroupID=function(t){for(var e=0,i=this.actorlist.length-1;i>=0;i--)this.actorlist[i].groupID==t&&e++;return e},i.prototype.setStartPosition=function(e,i){this.gameController.mainActor.jumpTo(e,i),t.gameCameraManager.follow(this.gameController.mainActor)},i.prototype.addRole=function(e,i,r){var o=t.TableManager.findUnitTableItem(e),n=t.playerManager.getRole(o.asset_id);n=n?n.clone():null;var a=new t.GameActor;return r&&(this.playerItem=o,this.gameController.mainActor=a),a.groupID=i,a.gameRoom=this,a.setRole(n,o),this.actorlist.push(a),this.gameScene.addChild(a),a.onBeAdded(),a},i.prototype.resetRole=function(t){return t.rebirth(),this.actorlist.indexOf(t)<0&&(this.actorlist.push(t),this.gameScene.addChild(t),t.onBeAdded()),t==this.gameController.mainActor&&(this._mainActorIsDeath=!1),t},i.prototype.removeRole=function(t){var e=this.actorlist.indexOf(t);e>=0&&this.actorlist.splice(e,1),this.gameScene.removeChild(t),t.onBeRemove()},i.prototype.useMap=function(e){this.sceneItem=t.TableManager.findSceneTableItem(e),this.gameScene&&t.sceneManager.leaveScene(this.gameScene),t.sceneManager.enterScene(this.sceneItem.asset_id),this.gameScene=t.sceneManager.currentScene,this.gameScene.terrainMesh&&this.gameScene.terrainMesh.addEventListener(t.PickEvent3D.PICK_DOWN,this.pickMove,this)},i.prototype.pickMove=function(e){console.log("walk"),this.gameController.mainActor.lockMove||this.gameController.mainActor.isDeath||t.logicManager.cancelMove||(this.gPoint.copyFrom(e.pickResult.globalPosition),this.gameController.mainActor.runAction(new t.ActionSequence([new t.ActionMoveTo(this.gPoint),new t.ActionAttackTo(this.gPoint)]))),t.logicManager.cancelMove=!1},i.prototype.gameOver=function(){this.isGameOver=!0,this._event3D.eventType=i.EVENT_GAME_OVER,this.dispatchEvent(this._event3D),t.timemer.timing(1e3,function(){return uiManager.showEnding()},null)},i.prototype.update=function(e,i){if(this._gameLevel.host.isDeath&&this._crystalMesh.visible){var r=t.sceneManager.currentScene.findObject3D("Fx_TowerExplode_01");r.play(1,!0),r.addEventListener(t.AnimationEvent3D.COMPLETE,this.gameOver,this),this._crystalMesh.visible=!1}if(!this._mainActorIsDeath)for(var o=0,n=this.actorlist;o<n.length;o++){var a=n[o];if(void 0==a.x&&(a.y=0),a.y=t.sceneManager.currentScene.getTerrainHeight(a.x,a.z)+10,a.isDeath){var s=this.actorlist.indexOf(a);s>=0&&(this.actorlist.splice(s,1),a.onBeRemove()),a!=this.gameController.mainActor?t.timemer.timing(3e3,this.removeRole,this,a):(this._mainActorIsDeath=!0,this.gameOver()),a.itemConfig.death_sound.length>0&&a.playAudio(a.itemConfig.death_sound)}}t.gameCameraManager.update(e,i)},i}(t.EventDispatcher);o.EVENT_MAIN_ACTOR_DEATH="event_main_actor_death",o.EVENT_GAME_OVER="event_game_over",t.GameRoom=o,__reflect(o.prototype,"egret3d.GameRoom");var n=function(){function t(){}return Object.defineProperty(t.prototype,"mainActor",{get:function(){return this._mainGameActor},set:function(t){this._mainGameActor=t},enumerable:!0,configurable:!0}),t}();t.GameController=n,__reflect(n.prototype,"egret3d.GameController"),t.logicManager=new e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){}return t.prototype.getRole=function(t){var e="anim/"+t+".e3dPack",i=RES.getRes(e);return i},t}();t.PlayerManager=e,__reflect(e.prototype,"egret3d.PlayerManager"),t.playerManager=new e}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(i,r){var o=e.call(this)||this;return o._state=0,o._delayTime=300,o._complete=!1,o._attackTarget=i,o._actionMoveTo=null,o._skillTable=t.TableManager.findSkillsTableItem(r),o}return __extends(i,e),i.prototype.onResetAction=function(t){this._state=0,this._delayTime=300,this._complete=!1},i.prototype.onIsActivate=function(t){return this._skillTable&&!this._attackTarget.isDeath},i.prototype.onTick=function(e,i,r){switch(this._delayTime-=r,this._state){case 0:if(t.Vector3D.distance(this._attackTarget.position,e.position)>this._skillTable.range)this._actionMoveTo||(this._actionMoveTo=new t.ActionMoveTo(this._attackTarget.position),this._actionMoveTo.onIsActivate(e)),this._actionMoveTo.onTick(e,i,r),(this._delayTime<=0||this._actionMoveTo.onIsComplete(e))&&(this._delayTime=300,this._actionMoveTo.resetTargetPoint(this._attackTarget.position),this._actionMoveTo.onResetAction(e));else{this._state=1,this._delayTime=this._skillTable.use_attack_speed?this._skillTable.start_time*(1/e.actorData.attack_speed):this._skillTable.start_time,e.isMove=!1,e.actorTrunToDirection(this._attackTarget.position.x-e.position.x,this._attackTarget.position.z-e.position.z);var o=t.damageTools.preCrit(this._skillTable,e);e.cast(this._skillTable.id,o)}break;case 1:if(this._delayTime<=0){this._state=2,this._delayTime=this._skillTable.use_attack_speed?this._skillTable.lock_time*(1/e.actorData.attack_speed):this._skillTable.lock_time,e.lockMove=!0,e.lockSkills=this._skillTable.id!=e.itemConfig.skill_0_id,e.actorData.mp-=this._skillTable.mp;var n=[];switch(this._skillTable.attack_type){default:n.push(this._attackTarget);break;case 1:e.findNearEnemy(n,this._skillTable.attack_range)}for(var a=n.length-1;a>=0;a--){var s=n[a],h=s.isDeath;if(!h){t.damageTools.calculateDamage(this._skillTable,e,n);var c=s.updateActorData();c&&s.hit(this._skillTable.hit_effect_name),s.isDeath?s.changeState("Death",1,!0):s!=e.gameRoom.gameController.mainActor&&s.changeState("Hit",1,!0),e==e.gameRoom.gameController.mainActor&&uiManager.hits(),e==e.gameRoom.gameController.mainActor&&s.isDeath&&e.addExp(s.itemConfig.exp)}}}e.actorTrunToDirection(this._attackTarget.position.x-e.position.x,this._attackTarget.position.z-e.position.z);break;case 2:this._delayTime<=0&&(this._state=3,this._delayTime=this._skillTable.use_attack_speed?this._skillTable.end_time*(1/e.actorData.attack_speed):this._skillTable.end_time,e.lockMove=!1);break;case 3:this._delayTime<=0&&(e.lockSkills=!1,this._skillTable.trigger_skills_id>0?(this._state=1,this._skillTable=t.TableManager.findSkillsTableItem(this._skillTable.trigger_skills_id),this._delayTime=this._skillTable.use_attack_speed?this._skillTable.start_time*(1/e.actorData.attack_speed):this._skillTable.start_time):this._complete=!0),e.actorTrunToDirection(this._attackTarget.position.x-e.position.x,this._attackTarget.position.z-e.position.z)}},i.prototype.onIsComplete=function(t){return this._complete},i.prototype.playSkill_effect=function(e,i,r){var o=t.effectManager.getEffect(i);o&&(o.play(r,!0),o.x=e.x,o.y=e.y,o.z=e.z,o.rotationY=e.rotationY,e.parent.addChild(o))},i}(t.ActionNode);t.ActionAttackTarget=e,__reflect(e.prototype,"egret3d.ActionAttackTarget")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(){t.instance=this}return t.prototype.getConfig=function(t){return i.buildDictionaryTableFromJsonData(RES.getRes(t),"id")},t.prototype.onInitialize=function(){return this._upgradeTable=this.getConfig("table/upgrade.json"),this._unitTable=this.getConfig("table/unit.json"),this._waveTable=this.getConfig("table/wave.json"),this._sceneTable=this.getConfig("table/scene.json"),this._equipTable=this.getConfig("table/equip.json"),this._skillsTable=this.getConfig("table/skills.json"),!0},t.findUpgradeTableItem=function(e){return t.instance._upgradeTable.findTableItem(e)},t.findUnitTableItem=function(e){return t.instance._unitTable.findTableItem(e)},t.findWaveTableItem=function(e){return t.instance._waveTable.findTableItem(e)},t.findSceneTableItem=function(e){return t.instance._sceneTable.findTableItem(e)},t.findEquipTableItem=function(e){return t.instance._equipTable.findTableItem(e)},t.findSkillsTableItem=function(e){return t.instance._skillsTable.findTableItem(e)},t.getSceneTableItemKeys=function(){return t.instance._sceneTable.getAllKeys()},t}();t.TableManager=e,__reflect(e.prototype,"egret3d.TableManager");var i=function(){function t(){this._tables={}}return t.prototype.findTableItem=function(t){return this._tables[t]},t.prototype.getAllKeys=function(){var t=[];for(var e in this._tables)t.push(e);return t},t.buildDictionaryTableFromJsonData=function(e,i){for(var r=new t,o=null,n=0;n<e.root.length;n++)o=e.root[n],r._tables[o[i]]=o;return r},t}();t.DictionaryTable=i,__reflect(i.prototype,"egret3d.DictionaryTable")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(i){this.stage3d=i,t.Egret3DEngine.instance.useDevicePOLICY(0),t.Egret3DEngine.instance.debug=!1,t.Egret3DPolicy.useAnimPoseInterpolation=!0,t.Egret3DPolicy.useAnimMixInterpolation=!0,t.Egret3DPolicy.useParticle=!0,t.Egret3DPolicy.useLowLoop=!0,this.view=new t.View3D(0,0,i.width,i.height),e.root=this.view,this.stage3d.addView3D(this.view),this._gameMain=new t.GameMain}return e.prototype.createGameScene=function(){return __awaiter(this,void 0,void 0,function(){var e,i=this;return __generator(this,function(r){switch(r.label){case 0:t.sceneManager.gameMain=this._gameMain,t.sceneManager.view=this.view,t.sceneManager.view.width=this.stage3d.width,t.sceneManager.view.height=this.stage3d.height,t.gameCameraManager.currentCamera=this.view.camera3D,window.addEventListener("resize",function(){return i.resize()}),r.label=1;case 1:return r.trys.push([1,6,,7]),[4,RES.loadConfig()];case 2:return r.sent(),[4,RES.getResAsync("ui/gameUI.json")];case 3:return r.sent(),[4,RES.getResAsync("ui/bg.jpg")];case 4:return r.sent(),[4,RES.getResAsync("ui/ui.json")];case 5:return r.sent(),[3,7];case 6:return e=r.sent(),console.error(e),[3,7];case 7:return this.initLoginView(),[2]}})})},e.prototype.initLoginView=function(){var e=["ShadowPlane.png","table/scene.json","table/skills.json","table/wave.json","table/unit.json","table/upgrade.json","table/equip.json"],i=function(){(t.TableManager.instance=new t.TableManager).onInitialize();var e=new LoginPage;uiManager.showPage(e)},r=new LoadingPage(e,i,this);uiManager.showPage(r),this.stage3d.addEventListener(t.Event3D.ENTER_FRAME,function(t){this._gameMain&&this._gameMain.update(t.time,t.delay)},this)},e.prototype.resize=function(){var e=this;setTimeout(function(){t.sceneManager.view.width=e.stage3d.width,t.sceneManager.view.height=e.stage3d.height},301)},e}();t.Scene=e,__reflect(e.prototype,"egret3d.Scene")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(e){function i(){var i=e.call(this)||this;return i._squeezePos=new t.Vector3D,i}return __extends(i,e),i.instance=function(){return i._instance=i._instance||new i,i._instance},i.prototype.bindGrass=function(t){this._grass=t},i.prototype.bindActor=function(t){this._target=t},i.prototype.update=function(t,i,r){e.prototype.update.call(this,t,i,r),null==this._target?this._grass.method.updateSqueezeData(this._squeezePos,!1,1,1):(this._squeezePos.copyFrom(this._target.globalPosition),this._squeezePos.decrementBy(this._grass.globalPosition),this._squeezePos.y=0,this._grass.method.updateSqueezeData(this._squeezePos,!0,160,.8))},i}(t.Object3D);t.GrassSqueeze=e,__reflect(e.prototype,"egret3d.GrassSqueeze")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function e(){}return e.getVector3D=function(e){var i=e.split(","),r=new t.Vector3D;if(i)switch(i.length){case 1:r.x=Number(i[0]);break;case 2:r.x=Number(i[0]),r.y=Number(i[1]);break;case 3:r.x=Number(i[0]),r.y=Number(i[1]),r.z=Number(i[2])}return r},e}();t.JSON_Util=e,__reflect(e.prototype,"egret3d.JSON_Util")}(egret3d||(egret3d={}));var EMathEx=function(){function t(){}return t.normalizeAngle=function(t){for(;t>180;)t-=360;for(;-180>t;)t+=360;return t},t.fNormalizeAngle=function(t){for(;t>180;)t-=360;
for(;-180>t;)t+=360;return t},t.radianToAngle=function(t){return 180*t/Math.PI},t.sign=function(t){return 0==t?0:t/Math.abs(t)},t}();__reflect(EMathEx.prototype,"EMathEx");var egret3d;!function(t){var e=function(){function e(t,e,i,r,o){this._cector3DPool=[],this.STRAIGHT_COST=1,this.DIAG_COST=Math.SQRT2,this._gridWidth=t,this._gridHeight=e,this._gridRow=i,this._gridCol=r,this._datas=o,this._gridoffsetX=0,this._gridoffsetY=0}return Object.defineProperty(e.prototype,"gridWidth",{get:function(){return this._gridWidth},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"gridHeight",{get:function(){return this._gridHeight},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"rowNum",{get:function(){return this._gridRow},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"colNum",{get:function(){return this._gridCol},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"datas",{get:function(){return this._datas},enumerable:!0,configurable:!0}),e.prototype.gridXToX=function(t){var e=t*this._gridWidth;return e+=this._gridoffsetX,e+=.5*this._gridWidth},e.prototype.gridYToY=function(t){var e=(this._gridRow-t-1)*this._gridHeight;return e+=this._gridoffsetY,e+=.5*this._gridHeight},e.prototype.xToGridX=function(t){var e=t;return e-=this._gridoffsetX,e=Math.floor(e/this._gridWidth)},e.prototype.yToGridY=function(t){var e=t;return e-=this._gridoffsetY,e=this._gridRow-Math.floor(e/this._gridHeight)-1},e.prototype.setUserData=function(t,e,i){var r=this._datas[e*this._gridCol+t];r.userData=i<<1|1&r.userData},e.prototype.isExistsUnit=function(t,e){return this._datas[e*this._gridCol+t].userData>>1!=0},e.prototype.getUserData=function(t,e){return this._datas[e*this._gridCol+t].userData>>1},e.createNavGridFromBuffer=function(r){var o=null,n=new t.ByteArray(r),a=n.readUnsignedInt();if(1312904775!=a)return null;var s=n.readUnsignedShort();switch(s){case 1:var h=n.readUnsignedByte(),c=n.readUnsignedByte(),l=n.readUnsignedByte(),g=n.readUnsignedByte(),p=l*g;p+=p%8?8-p%8:0;for(var u=new Array(p),d=0,f=n.readUnsignedShort(),_=0;f>_;_++){var m=n.readUnsignedByte();u[d]=new i(d%g,Math.floor(d/g)),u[d++].userData=(128&m)>>7,u[d]=new i(d%g,Math.floor(d/g)),u[d++].userData=(64&m)>>6,u[d]=new i(d%g,Math.floor(d/g)),u[d++].userData=(32&m)>>5,u[d]=new i(d%g,Math.floor(d/g)),u[d++].userData=(16&m)>>4,u[d]=new i(d%g,Math.floor(d/g)),u[d++].userData=(8&m)>>3,u[d]=new i(d%g,Math.floor(d/g)),u[d++].userData=(4&m)>>2,u[d]=new i(d%g,Math.floor(d/g)),u[d++].userData=(2&m)>>1,u[d]=new i(d%g,Math.floor(d/g)),u[d++].userData=1&m}o=new e(h,c,l,g,u);break;default:return console.log("Unknown file version! version: "+s+"."),null}return o},e.prototype.findNearbyNode=function(e,i){for(var r,o=Math.max(Math.floor(this.rowNum/2),Math.floor(this.colNum/2)),n=new t.Vec2,a=1;o>a;a++){n.x=i.x-a,n.y=i.y-a;for(var s=0;2*a>=s;s++)if((r=this.getNode(n.x+s,n.y))&&r.isPass)return r.H=this.diagoal(r,i),r;n.x=i.x+a,n.y=i.y-a;for(var s=0;2*a>=s;s++)if((r=this.getNode(n.x,n.y+s))&&r.isPass)return r.H=this.diagoal(r,i),r;n.x=i.x-a,n.y=i.y+a;for(var s=0;2*a>=s;s++)if((r=this.getNode(n.x+s,n.y))&&r.isPass)return r.H=this.diagoal(r,i),r;n.x=i.x-a,n.y=i.y-a;for(var s=0;2*a>=s;s++)if((r=this.getNode(n.x,n.y+s))&&r.isPass)return r.H=this.diagoal(r,i),r}return null},e.prototype.findPath=function(e,i,r,o){void 0===o&&(o=!0);for(var n=this,a=r.length-1;a>=0;a--)n._cector3DPool.push(r[a]);r.length=0;var s=n.getNode(n.xToGridX(e.x),n.yToGridY(e.z)),h=n.getNode(n.xToGridX(i.x),n.yToGridY(i.z));if(1==o&&0==h.isPass&&(h=n.findNearbyNode(s,h),null==h))return!1;if(n._findPath(s,h))for(var c,a=0;a<n._path.length;a++)n._cector3DPool.length>0?(c=n._cector3DPool.shift(),c.x=n.gridXToX(n._path[a].x),c.y=0,c.z=n.gridYToY(n._path[a].y),r.push(c)):r.push(new t.Vector3D(n.gridXToX(n._path[a].x),0,n.gridYToY(n._path[a].y)));return r.length>1&&r.shift(),r.length>0},e.prototype.isPass=function(t,e){return this.getNode(t,e).isPass},e.prototype._findPath=function(t,e){this._openList=[],this._closeList=[],this._path=[];var i=t;for(i.G=0,i.H=this.diagoal(i,e),i.F=i.G+i.H;i!==e;){for(var r=Math.max(0,i.x-1),o=Math.max(0,i.y-1),n=Math.min(this.colNum-1,i.x+1),a=Math.min(this.rowNum-1,i.y+1),s=r;n>=s;s++)for(var h=o;a>=h;h++){var c=this.getNode(s,h);if(c!==i&&c.isPass!==!1){var l=this.STRAIGHT_COST;i.x!==c.x&&i.y!==c.y&&(l=this.DIAG_COST);var g=i.G+l,p=this.diagoal(c,e),u=g+p;this.isOpen(c)||this.isClose(c)?u<c.F&&(c.F=u,c.G=g,c.H=p,c.parent=i):(c.F=u,c.G=g,c.H=p,c.parent=i,this._openList.push(c))}}if(this._closeList.push(i),0===this._openList.length)return!1;this._openList.sort(function(t,e){return t.F<e.F?-1:1}),i=this._openList.shift()}for(i=e,this._path.unshift(i);i!==t;)i=i.parent,this._path.unshift(i);return!0},e.prototype.getNode=function(t,e){return this._datas[e*this.colNum+t]},e.prototype.isClose=function(t){return this._closeList.indexOf(t)>-1},e.prototype.isOpen=function(t){return this._openList.indexOf(t)>-1},e.prototype.diagoal=function(t,e){var i=Math.abs(t.x-e.x),r=Math.abs(t.y-e.y),o=Math.min(i,r),n=i+r;return this.DIAG_COST*o+this.STRAIGHT_COST*(n-1*o)},e}();t.NavGrid=e,__reflect(e.prototype,"egret3d.NavGrid");var i=function(){function t(t,e){this.x=t,this.y=e}return Object.defineProperty(t.prototype,"isPass",{get:function(){return 0==this.userData},enumerable:!0,configurable:!0}),t}();t.AStarNode=i,__reflect(i.prototype,"egret3d.AStarNode")}(egret3d||(egret3d={}));var egret3d;!function(t){var e=function(){function t(t,e){void 0===t&&(t=0),void 0===e&&(e=0),this.x=t,this.y=e}return Object.defineProperty(t.prototype,"lengthSquared",{get:function(){return this.x*this.x+this.y*this.y},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"length",{get:function(){return Math.sqrt(this.lengthSquared)},enumerable:!0,configurable:!0}),t.prototype.normalize=function(t){if(void 0===t&&(t=1),0!=this.length){var e=t/this.length;return this.x*=e,void(this.y*=e)}},t.prototype.distance=function(t){var e=this.x-t.x,i=this.y-t.y;return Math.sqrt(e*e+i*i)},t.prototype.scaleBy=function(t){this.x*=t,this.y*=t},t.prototype.subtract=function(e,i){return i||(i=new t),i.x=this.x-e.x,i.y=this.y-e.y,i},t.prototype.add=function(e,i){return i||(i=new t),i.x=this.x+e.x,i.y=this.y+e.y,i},t.prototype.copyFrom=function(t){this.x=t.x,this.y=t.y},t}();t.Vec2=e,__reflect(e.prototype,"egret3d.Vec2")}(egret3d||(egret3d={}));var BattlePage=function(t){function e(){var e=t.call(this)||this;e._radio=.8,e.hitCount=0,e.hitTime=0,e.bloodList=[],e.hpBarList=[];var i=UIManager.gameWidth,r=UIManager.gameHeight;e.bloodLayer=new egret.DisplayObjectContainer,e.addChild(e.bloodLayer),e.hpBarLayer=new egret.DisplayObjectContainer,e.addChild(e.hpBarLayer);var o=new egret.Bitmap;o.texture=RES.getRes("ui2/gameUI.json#scene_100000.png"),o.x=.5*(i-o.width),o.x=0,o.y=0,o.scaleX=o.scaleY=e._radio,e.addChild(o);var n=e.spriteBackTown=new egret.Bitmap;n.texture=RES.getRes("ui2/gameUI.json#fh.png"),n.x=i-n.width+20,n.y=r-n.height-100,n.scaleX=n.scaleY=.8,e.addChild(n);var a=e.hitContainer=new HitContainer;a.scaleX=a.scaleY=e._radio,a.x=20,a.y=.3*r,e.addChild(a),e.hitContainer.visible=!1;var s=e.timeKeeper=new TimeKeeper;s.x=i-s.width/e._radio-80,s.y=7,s.scaleX=s.scaleY=e._radio,e.addChild(s),e.expBar=new ProcessBar("ui2/gameUI.json#hpbar_bg.png","ui/gameUI.json#expbar.png"),e.expBar.height=10,e.expBar.width=384,e.expBar.x=(i-e.expBar.width)/2,e.expBar.y=r-e.expBar.height,e.addChild(e.expBar),e.skillBar=new SkillBar(96,96);var h=egret3d.logicManager.currentGameRoom.playerItem;return e.skillBar.addSkillButton(h.skill_1_id,"skilla.png",egret3d.KeyCode.Key_Q),e.skillBar.addSkillButton(h.skill_2_id,"skillb.png",egret3d.KeyCode.Key_W),e.skillBar.addSkillButton(h.skill_3_id,"skillc.png",egret3d.KeyCode.Key_E),e.skillBar.addSkillButton(h.skill_4_id,"skilld.png",egret3d.KeyCode.Key_R),e.skillBar.x=.5*i-.5*e.skillBar.width,e.skillBar.y=r-e.skillBar.height-10,e.addChild(e.skillBar),n.touchEnabled=!0,e}return __extends(e,t),e.prototype.onEnterPage=function(){this.spriteBackTown.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onButtonClick,this)},e.prototype.onLeavePage=function(){this.spriteBackTown.removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onButtonClick,this);for(var t=0,e=this.hpBarList;t<e.length;t++){var i=e[t];i.hpBar.parent&&i.hpBar.parent.removeChild(i.hpBar)}this.hpBarList.length=0,this.timeKeeper.stop(),this.timeKeeper.reset(),this.hitContainer.clear()},e.prototype.onButtonClick=function(t){t.target===this.spriteBackTown&&(this.timeKeeper.stop(),egret3d.logicManager.exit())},e.prototype.blood=function(t,e){var i=new Blood;i.createNumberView(e),i.pos3D=t.position.clone(),i.pos3D.y+=200,this.bloodLayer.addChild(i),i.pos3DTo2DFun=egret3d.Scene.root.camera3D.object3DToScreenRay,i.camera=egret3d.Scene.root.camera3D;var r=egret3d.Scene.root.camera3D.object3DToScreenRay(i.pos3D),o=this.bloodLayer.stage;o?(i.x=r.x,i.y=r.y):(i.x=-100,i.y=-100),this.bloodList.push(i)},e.prototype.addHpBar=function(t,e){this.hpBarList.push({target:t,hpBar:e}),this.hpBarLayer.addChild(e);var i=egret3d.Scene.root.camera3D.object3DToScreenRay(t.position);e.x=i.x,e.y=i.y},e.prototype.update=function(t,e){for(var i=0,r=this.bloodList;i<r.length;i++){var o=r[i];if(o.complete){var n=this.bloodList.indexOf(o);this.bloodList.splice(n,1),this.bloodLayer.removeChild(o)}else o.update(t,e)}for(var a=0,s=this.hpBarList;a<s.length;a++){var h=s[a],c=h.target.position.clone();0===h.target.groupID&&(c.y+=100),c.y+=150,c=egret3d.Scene.root.camera3D.object3DToScreenRay(c);var l=this.bloodLayer.stage;l&&(h.hpBar.x=c.x-h.hpBar.width/2,h.hpBar.y=c.y)}},e}(egret.DisplayObjectContainer);__reflect(BattlePage.prototype,"BattlePage");var Blood=function(t){function e(){var e=t.apply(this,arguments)||this;return e.complete=!1,e._g=80.8,e._speedY=-8,e._lifeTime=800,e._scale=50,e._speedX=2,e._speedZ=3,e._minSpeedX=2,e._maxSpeedX=4,e}return __extends(e,t),e.prototype.createNumberView=function(t){if(0!==t){t=Math.floor(t);for(var e=[];t>0;)e.push(t%10),t=Math.floor(t/10);e.reverse();for(var i,r=0;r<e.length;r++)i=new egret.Bitmap,i.texture=RES.getRes("ui/gameUI.json#"+e[r]+".png"),i.width=i.height=20,i.x=i.width*r*.8,this.addChild(i);this._width=i.x+i.width,this._speedX=Math.random()*(this._maxSpeedX-this._minSpeedX)+this._minSpeedX,Math.random()>.5&&(this._speedX*=-1)}},Object.defineProperty(e.prototype,"width",{get:function(){return this._width},enumerable:!0,configurable:!0}),e.prototype.update=function(t,e){if(this._lifeTime<=0)return void(this.complete=!0);var i=this.camera.object3DToScreenRay(this.pos3D),r=this.stage;r&&(this.x=i.x,this.y=i.y),this.pos3D.y-=this._speedY*e/1e3*this._scale,this._speedY+=this._g*e/1e3,this._speedY>5&&(this._speedY=5),this._lifeTime-=e,this.pos3D.x+=this._speedX,this.pos3D.z+=this._speedZ},e}(egret.Sprite);__reflect(Blood.prototype,"Blood");var HitContainer=function(t){function e(){var e=t.call(this)||this;e.hitCount=0,e.hitTime=0;var i=new egret.Bitmap;i.texture=RES.getRes("ui/gameUI.json#hits.png");var r=e.number1=new egret.Bitmap;r.texture=RES.getRes("ui/gameUI.json#1.png"),r.x=i.width;var o=e.number2=new egret.Bitmap;return o.texture=RES.getRes("ui/gameUI.json#1.png"),o.x=r.x+r.width,e.addChild(i),e.addChild(r),e.addChild(o),e.number2.visible=!1,e}return __extends(e,t),e.prototype.hits=function(){this.visible=!0,this.number2.visible=!1,this.hitCount++,this.hitCount>99&&(this.hitCount=99),this.hitCount>9?(this.number1.texture=RES.getRes("ui/gameUI.json#"+Math.floor(this.hitCount/10)+".png"),this.number2.texture=RES.getRes("ui/gameUI.json#"+Math.floor(this.hitCount%10)+".png"),this.number2.visible=!0):this.number1.texture=RES.getRes("ui/gameUI.json#"+this.hitCount+".png"),this.hitTween1&&this.hitTween1.kill(),this.hitTween2&&this.hitTween2.kill(),this.number1.scaleX=this.number1.scaleY=2,this.number2.scaleX=this.number2.scaleY=2,this.hitTween1=TweenLite.to(this.number1,.1,{scaleX:1,scaleY:1,ease:Linear.easeIn}),this.hitTween2=TweenLite.to(this.number2,.1,{scaleX:1,scaleY:1,ease:Linear.easeIn}),this.hitTime>0&&clearTimeout(this.hitTime),this.hitTime=setTimeout(function(){this.visible=!1,this.hitCount=0,clearTimeout(this.hitTime)}.bind(this),2e3)},e.prototype.clear=function(){this.hitTween1&&this.hitTween1.kill(),this.hitTween2&&this.hitTween2.kill(),this.hitTime>0&&clearTimeout(this.hitTime),this.visible=!1,this.hitCount=0,this.number2.visible=!1},e}(egret.Sprite);__reflect(HitContainer.prototype,"HitContainer");var ProcessBar=function(t){function e(e,i){var r=t.call(this)||this;return r.background=new egret.Bitmap,r.background.texture=RES.getRes(e),r.addChild(r.background),r.bar=new egret.Bitmap,r.bar.texture=RES.getRes(i),r.addChild(r.bar),r}return __extends(e,t),Object.defineProperty(e.prototype,"ratio",{get:function(){return this._ratio},set:function(t){this._ratio=t,this.bar.scaleX=t},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"width",{get:function(){return this.background.width},set:function(t){this.bar.width=this.background.width=t},enumerable:!0,configurable:!0}),e}(egret.Sprite);__reflect(ProcessBar.prototype,"ProcessBar");var CDButton1=function(t){function e(e,i,r,o,n){var a=t.call(this)||this;a.cdTime=1e3,a.currTime=0,a.width=o,a.height=n;var s=new egret.Bitmap;s.texture=RES.getRes("ui/gameUI.json#"+i),s.width=o,s.height=n,a.addChild(s);var h=a.maskTexture=new egret.Shape;h.graphics.beginFill(0,.75),h.graphics.drawRect(0,0,o,n),h.graphics.endFill(),h.width=o,h.height=n,h.mask=a.maskRect=new egret.Rectangle(0,0,o,n),a.addChild(h);var c=new egret.Bitmap;return c.texture=RES.getRes("ui/gameUI.json#SkillBox.png"),c.width=o,c.height=n,a.addChild(c),a.touchEnabled=!0,a.clearTime(),a}return __extends(e,t),e.prototype.bindKeyboard=function(t){},e.prototype.unbindKeyboard=function(){},e.prototype.canUse=function(){return!this.maskTexture.visible},e.prototype.startTime=function(t){var e=this;this.currTime=0,this.cdTime=t,this.maskTexture.visible=!0,TweenLite.to(this.maskRect,this.cdTime/1e3,{y:this.height,onUpdate:function(){e.maskRect.height=e.height-e.maskRect.y,e.maskTexture.mask=e.maskRect},onComplete:function(){e.maskTexture.visible=!1,e.clearTime()}})},e.prototype.clearTime=function(){this.currTime=0,this.maskRect.x=0,this.maskRect.y=0,this.maskRect.width=this.width,this.maskRect.height=this.height,this.maskTexture.mask=this.maskRect,this.maskTexture.visible&&(this.maskTexture.visible=!1)},e}(egret.Sprite);__reflect(CDButton1.prototype,"CDButton1");var SkillBar=function(t){function e(e,i){void 0===e&&(e=64),void 0===i&&(i=64);var r=t.call(this)||this;return r.skillsId=[],r.skillsButton=[],r.skillButtonWidth=64,r.skillButtonHeight=64,r.skillButtonWidth=e,r.skillButtonHeight=i,r}return __extends(e,t),e.prototype.addSkillButton=function(t,e,i){void 0===i&&(i=0);var r=new CDButton1(e,e,e,this.skillButtonWidth,this.skillButtonHeight);return i>0&&r.bindKeyboard(i),this.skillsId.push(t),this.skillsButton.push(r),r.x=this.skillButtonWidth*(this.skillsButton.length-1),this.addChild(r),this.width=this.skillButtonWidth*this.skillsButton.length,r.addEventListener(egret.TouchEvent.TOUCH_BEGIN,this.onClick,this),r},e.prototype.onClick=function(t){console.log("skill"),egret3d.logicManager.cancelMove=!0;var e=this.skillsButton.indexOf(t.target),i=this.skillsButton[e];if(i.canUse()){new egret3d.ProtagonistLogic;var r=egret3d.logicManager.currentGameRoom.gameController.mainActor,o=(r.performer,[]);if(r.findNearEnemy(o),o.length>0&&!r.lockSkills)switch(o.sort(function(t,e){return egret3d.Vector3D.distance(r.position,t.position)<egret3d.Vector3D.distance(r.position,e.position)?-1:1}),e){case 0:r.runAction(new egret3d.ActionSequence([new egret3d.ActionAttackTarget(o[0],r.itemConfig.skill_1_id),new egret3d.ActionRepeat(new egret3d.ActionAttackTarget(o[0],r.itemConfig.skill_0_id),-1)])),this.skillsButton[e].startTime(egret3d.TableManager.findSkillsTableItem(r.itemConfig.skill_1_id).cd_time);break;case 1:r.runAction(new egret3d.ActionSequence([new egret3d.ActionAttackTarget(o[0],r.itemConfig.skill_2_id),new egret3d.ActionRepeat(new egret3d.ActionAttackTarget(o[0],r.itemConfig.skill_0_id),-1)])),this.skillsButton[e].startTime(egret3d.TableManager.findSkillsTableItem(r.itemConfig.skill_2_id).cd_time);break;case 2:r.runAction(new egret3d.ActionSequence([new egret3d.ActionAttackTarget(o[0],r.itemConfig.skill_3_id),new egret3d.ActionRepeat(new egret3d.ActionAttackTarget(o[0],r.itemConfig.skill_0_id),-1)])),this.skillsButton[e].startTime(egret3d.TableManager.findSkillsTableItem(r.itemConfig.skill_3_id).cd_time);break;case 3:r.runAction(new egret3d.ActionSequence([new egret3d.ActionAttackTarget(o[0],r.itemConfig.skill_4_id),new egret3d.ActionRepeat(new egret3d.ActionAttackTarget(o[0],r.itemConfig.skill_0_id),-1)])),this.skillsButton[e].startTime(egret3d.TableManager.findSkillsTableItem(r.itemConfig.skill_4_id).cd_time)}}},e}(egret.Sprite);__reflect(SkillBar.prototype,"SkillBar");var TimeKeeper=function(t){function e(){var e=t.call(this)||this;e.number1=new egret.Bitmap,e.number2=new egret.Bitmap,e.number3=new egret.Bitmap,e.number4=new egret.Bitmap;var i=new egret.Bitmap;i.texture=RES.getRes("ui/gameUI.json#bg_title.png"),e.addChild(i);var r=new egret.Bitmap;r.texture=RES.getRes("ui/gameUI.json#maohao.png"),r.width=20,r.height=20,e.addChild(r);var o=45;e.numbers=[e.number1,e.number2,e.number3,e.number4];for(var n=0;4>n;n++){var a=e.numbers[n];a.texture=RES.getRes("ui/gameUI.json#0.png"),a.width=20,a.height=20,a.x=o+a.width*n+(n>=2?r.width:0),a.y=a.height,e.addChild(a)}return r.x=o+40,r.y=r.height,e}return __extends(e,t),e.prototype.start=function(){var t=this,e=new Date;this.stop(),this.timer=setInterval(function(){t.formatDuring((new Date).getTime()-e.getTime())},1e3)},e.prototype.stop=function(){clearInterval(this.timer)},e.prototype.reset=function(){for(var t,e=0;4>e;e++)t=this.numbers[e],t.texture=RES.getRes("ui/gameUI.json#0.png")},e.prototype.formatDuring=function(t){var e,i=(Math.floor(t/864e5),Math.floor(t%864e5/36e5),Math.floor(t%36e5/6e4)),r=Math.floor(t%6e4/1e3);this.reset(),i>9?(e=this.number1,e.texture=RES.getRes("ui/gameUI.json#"+Math.floor(i/10)+".png"),e=this.number2,e.texture=RES.getRes("ui/gameUI.json#"+i%10+".png")):(e=this.number2,e.texture=RES.getRes("ui/gameUI.json#"+i+".png")),r>9?(e=this.number3,e.texture=RES.getRes("ui/gameUI.json#"+Math.floor(r/10)+".png"),e=this.number4,e.texture=RES.getRes("ui/gameUI.json#"+r%10+".png")):(e=this.number4,e.texture=RES.getRes("ui/gameUI.json#"+r+".png"))},e}(egret.Sprite);__reflect(TimeKeeper.prototype,"TimeKeeper");var EndingPage=function(t){function e(){var e=t.call(this)||this,i=new egret.Bitmap;i.texture=RES.getRes("ui/gameUI.json#endingPanel.png"),e.addChild(i);var r=new egret.Bitmap;return r.texture=RES.getRes("ui/gameUI.json#leaveBtnUp.png"),r.x=319,r.y=367,e.addChild(r),r.touchEnabled=!0,r.addEventListener(egret.TouchEvent.TOUCH_TAP,function(){egret3d.logicManager.exit(),uiManager.leaveEnding()},e),e}return __extends(e,t),e}(egret.DisplayObjectContainer);__reflect(EndingPage.prototype,"EndingPage");var LoadingPage=function(t){function e(e,i,r){var o=t.call(this)||this;o.fileURLs=e,o.callbackFun=i,o.callbackObj=r;var n="ui/bg.jpg";return o.once(egret.Event.ADDED_TO_STAGE,function(){o.onAdd(n)},o),o}return __extends(e,t),e.prototype.onAdd=function(t){var e=this.stage.stageWidth,i=this.stage.stageHeight;if(t){var r=new egret.Bitmap;r.texture=RES.getRes(t),this.addChild(r)}this.totalProgress=new ProcessBar("ui/gameUI.json#hpbar_bg.png","ui/gameUI.json#expbar.png"),this.totalProgress.width=e-100,this.totalProgress.height=10,this.totalProgress.ratio=0,this.totalProgress.x=50,this.totalProgress.y=.5*(i-this.totalProgress.height)-10,this.addChild(this.totalProgress)},e.prototype.onEnterPage=function(){var t=this;this.fileURLs=this.fileURLs.map(function(t){return t.replace("resource/","")}),console.log(this.fileURLs),this._count=0,this._total=this.fileURLs.length,Promise.all(this.fileURLs.map(function(e){return RES.getResAsync(e,t.onOnceComplete,t)})).then(function(){t.onTotalLoadComplete()})},e.prototype.onLeavePage=function(){this._count=0,this._total=0,this.callbackFun=null,this.callbackObj=null},e.prototype.onOnceComplete=function(){this._count++,this.totalProgress.ratio=this._count/this._total},e.prototype.onTotalLoadComplete=function(){var t=this;if(this.callbackFun){var e={getAsset:function(t){t=t.replace("resource/",""),RES.profile();var e=RES.getRes(t);return e}};setTimeout(function(){return t.callbackFun.call(t.callbackObj,e)},100)}},e}(egret.DisplayObjectContainer);__reflect(LoadingPage.prototype,"LoadingPage");var LoginPage=function(t){function e(){var e=t.call(this)||this;return e.once(egret.Event.ADDED_TO_STAGE,e.onAdd,e),e}return __extends(e,t),e.prototype.onAdd=function(){var t=UIManager.gameWidth,e=UIManager.gameHeight,i=new egret.Bitmap;i.texture=RES.getRes("ui/bg.jpg"),this.addChild(i);var r=new egret.Bitmap;r.texture=RES.getRes("ui/ui.json#logo"),r.x=.5*t-.5*r.width,r.y=.5*e-.5*r.height-r.height,this.addChild(r);var o=this.enterGameButton=new egret.Bitmap;o.texture=RES.getRes("ui/ui.json#menu"),o.x=.5*t-.5*o.width,o.y=r.y+r.height+220,this.addChild(o);var n=new egret.Bitmap;n.texture=RES.getRes("ui/gameUI.json#powerByEgert3D.png"),n.x=i.width-n.width,n.y=this.stage.stageHeight-n.height,this.addChild(n),this.enterGameButton.touchEnabled=!0,this.enterGameButton.addEventListener(egret.TouchEvent.TOUCH_TAP,this.onButtonClick,this)},e.prototype.onButtonClick=function(t){switch(t.target){case this.enterGameButton:var e=new RoomPage;uiManager.showPage(e)}},e}(egret.DisplayObjectContainer);__reflect(LoginPage.prototype,"LoginPage");var RoomPage=function(t){function e(){var e=t.call(this)||this;e.mapItem=[];var i=UIManager.gameWidth,r=(UIManager.gameHeight,new egret.Bitmap);r.texture=RES.getRes("ui/bg.jpg"),e.addChild(r);var o=new egret.Bitmap;o.texture=RES.getRes("ui/ui.json#title"),o.x=.5*i-.5*o.width,o.y=100,e.addChild(o);var n=egret3d.TableManager.getSceneTableItemKeys(),a=n.length;egret3d.logicManager.setLocalStorageItem(n[0],"false");for(var s=40,h=280,c=0;a>c;c++){var l=new MapItem1("pic"+(c+1),Math.min(c+1,4),"false"!=egret3d.logicManager.getLocalStorageItem(n[c]));l.sceneID=parseInt(n[c]),l.x=s+310*Math.floor(c%2),l.y=h+230*Math.floor(c/2),e.addChild(l),e.mapItem.push(l),l.touchEnabled=!0}return e}return __extends(e,t),e.prototype.onEnterPage=function(){for(var t=egret3d.TableManager.getSceneTableItemKeys(),e=this.mapItem.length,i=0;e>i;i++)this.mapItem[i].addEventListener(egret.TouchEvent.TOUCH_TAP,this.onButtonClick,this),this.mapItem[i].lock="false"!=egret3d.logicManager.getLocalStorageItem(t[i])},e.prototype.onLeavePage=function(){for(var t=0,e=this.mapItem.length;e>t;t++)this.mapItem[t].removeEventListener(egret.TouchEvent.TOUCH_TAP,this.onButtonClick,this)},e.prototype.onButtonClick=function(t){if(t.target===this.backBut)uiManager.showPage(new LoginPage);else for(var e=0,i=this.mapItem.length;i>e;e++)t.target===this.mapItem[e]&&this.mapItem[e].lock===!1&&(uiManager.removePage(),egret3d.sceneManager.changeScene(this.mapItem[e].sceneID))},e}(egret.DisplayObjectContainer);__reflect(RoomPage.prototype,"RoomPage");var MapItem1=function(t){function e(e,i,r){var o=t.call(this)||this;o.sceneID=1e5;var n=new egret.Bitmap;n.texture=RES.getRes("ui/ui.json#"+e),o.addChild(n),n.x=10,n.y=10;var a=new egret.Bitmap;if(a.texture=RES.getRes("ui/ui.json#bk"),o.addChild(a),o.lock=r,i>0){for(var s=[],h=0;i>h;h++){var c=new egret.Bitmap;c.texture=RES.getRes("ui/ui.json#star"),c.anchorOffsetX=c.width/2,c.x=a.width/2-(i-1)/2*(c.width+2)+h*(c.width+2),c.y=0,s.push(c)}s.reverse();for(var h=0;h<s.length;h++)o.addChild(s[h])}return o.width=n.width,o}return __extends(e,t),Object.defineProperty(e.prototype,"lock",{get:function(){return this._lock&&this._lock.visible},set:function(t){this.lock||(this._lock=new egret.Bitmap,this._lock.texture=RES.getRes("ui/ui.json#suo"),this._lock.x=.5*this.width-.5*this._lock.width,this._lock.y=.5*this.height-.5*this._lock.height,this.addChild(this._lock)),this._lock.visible=t},enumerable:!0,configurable:!0}),e}(egret.DisplayObjectContainer);__reflect(MapItem1.prototype,"MapItem1");var UIManager=function(){function t(e){this.container=e,t.gameWidth=e.stage.stageWidth,t.gameHeight=e.stage.stageHeight}return t.prototype.showPage=function(t){this.removePage(),this.currentPage=t,this.container.addChild(t),t.onEnterPage&&t.onEnterPage()},t.prototype.removePage=function(){this.currentPage&&(this.currentPage.onLeavePage&&this.currentPage.onLeavePage(),this.container.removeChild(this.currentPage),this.currentPage=null)},t.prototype.showBattle=function(){this.battlePage||(this.battlePage=new BattlePage),this.battlePage.onEnterPage(),this.container.addChild(this.battlePage)},t.prototype.updateBattle=function(t,e){this.battlePage||(this.battlePage=new BattlePage),this.battlePage.update(t,e)},t.prototype.blood=function(t,e){this.battlePage||(this.battlePage=new BattlePage),this.battlePage.blood(t,e)},t.prototype.addHpBar=function(t,e){this.battlePage||(this.battlePage=new BattlePage),this.battlePage.addHpBar(t,e)},t.prototype.startTimeKeeper=function(){this.battlePage||(this.battlePage=new BattlePage),this.battlePage.timeKeeper.start()},t.prototype.stopTimeKeeper=function(){this.battlePage||(this.battlePage=new BattlePage),this.battlePage.timeKeeper.stop()},t.prototype.hits=function(){this.battlePage||(this.battlePage=new BattlePage),this.battlePage.hitContainer.hits()},t.prototype.updateExpBar=function(t){this.battlePage||(this.battlePage=new BattlePage),this.battlePage.expBar.ratio=t},t.prototype.leaveBattle=function(){this.battlePage.onLeavePage(),this.container.removeChild(this.battlePage)},t.prototype.showEnding=function(){this.endingPage||(this.endingPage=new EndingPage),this.endingPage.x=(t.gameWidth-this.endingPage.width)/2,this.endingPage.y=(t.gameHeight-this.endingPage.height)/2,this.container.addChild(this.endingPage)},t.prototype.leaveEnding=function(){this.container.removeChild(this.endingPage)},t}();UIManager.gameWidth=0,UIManager.gameHeight=0,__reflect(UIManager.prototype,"UIManager");var uiManager;